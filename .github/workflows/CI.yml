name: Deploy Astro to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  download-music:
    name: Download Music
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.22.0'
      - name: Install ffmpeg (if missing)
        run: |
          if ! command -v ffmpeg >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y ffmpeg
          fi
      - name: Disable bin links in pnpm (workaround for missing binary sources)
        run: |
          pnpm config set bin-links false
      - name: Configure Git to use HTTPS for GitHub
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
      - name: Run download script
        run: |
          node --version
          ffmpeg -version || true
          node scripts/download-music.js

      - name: Commit and push downloaded music (if any)
        run: |
          # 1. Set remote to HTTPS for pushing first
          git remote set-url origin https://github.com/Vedaru/vedarublog.github.io.git

          # 2. Stage all music changes (including deletions like .m4a)
          # We must stage/commit BEFORE pulling to avoid "unstaged changes" error during rebase
          git add -A public/assets/music public/music || true

          # 3. If no staged changes, skip
          if git diff --staged --quiet; then
            echo "No music changes to commit"
            exit 0
          fi

          # 4. Prevent commit loops: if the latest commit message indicates an automated music update, skip
          LATEST_MSG=$(git log -1 --pretty=%B 2>/dev/null || true)
          echo "Latest commit message: $LATEST_MSG"
          if echo "$LATEST_MSG" | grep -q -E '^chore:.*music'; then
            echo "Skipping commit because latest commit is an automated music update"
            exit 0
          fi

          # 5. Commit changes locally
          git -c user.name="Vedaru" -c user.email="Vedaru@users.noreply.github.com" commit -m "chore: update music â€” replace m4a with mp3 (automated)"

          # 6. Pull latest changes from remote and rebase our new commit on top
          # This handles the case where main updated while this job was running
          git pull --rebase origin main

          # 7. Push the unified history
          git push origin HEAD:main

  check:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    name: Astro Check
    runs-on: ubuntu-latest
    needs: download-music
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable corepack (makes pnpm available)
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
          run_install: false

      - name: Verify pnpm installation
        run: |
          echo "PNPMç‰ˆæœ¬:"
          pnpm --version
          echo "Nodeç‰ˆæœ¬:"
          node --version

      - name: Force git to use HTTPS for GitHub
        run: |
          echo "Rewriting git@github.com: to https://github.com/ to avoid SSH cloning failures"
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install system dependencies (libvips)
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev build-essential

      - name: Install dependencies
        env:
          CI: true
          DISABLE_OPENCOLLECTIVE: 1
          NPM_CONFIG_UPDATE_NOTIFIER: false
        run: pnpm install --frozen-lockfile

      - name: Run Astro Check
        run: pnpm astro check
        env:
          ENABLE_CONTENT_SYNC: false

  build-and-deploy:
    name: Build and Deploy
    needs: check
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Cleanup previous artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            const githubPagesArtifacts = artifacts.data.artifacts.filter(
              (artifact) => artifact.name === 'github-pages'
            );
            
            if (githubPagesArtifacts.length > 1) {
              console.log(`Found ${githubPagesArtifacts.length} github-pages artifacts, cleaning up...`);
              
              // Keep only the most recent one
              githubPagesArtifacts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              for (let i = 1; i < githubPagesArtifacts.length; i++) {
                console.log(`Deleting artifact: ${githubPagesArtifacts[i].id}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: githubPagesArtifacts[i].id,
                });
              }
            }

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable corepack (makes pnpm available)
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
          run_install: false

      - name: Verify pnpm installation
        run: |
          echo "PNPMç‰ˆæœ¬:"
          pnpm --version
          echo "Nodeç‰ˆæœ¬:"
          node --version
          echo "å½“å‰ç›®å½•:"
          pwd
          ls -la

      - name: Force git to use HTTPS for GitHub
        run: |
          echo "Rewriting git@github.com: to https://github.com/ to avoid SSH cloning failures"
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install system dependencies (libvips)
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev build-essential

      - name: Install dependencies
        env:
          CI: true
          DISABLE_OPENCOLLECTIVE: 1
          NPM_CONFIG_UPDATE_NOTIFIER: false
        run: |
          echo "å®‰è£…ä¾èµ–..."
          pnpm install --frozen-lockfile
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run Astro Build
        run: |
          echo "å¼€å§‹æ„å»º Astro é¡¹ç›®..."
          echo "ä»“åº“å: ${{ github.event.repository.name }}"
          echo "BASE_PATH ç¯å¢ƒå˜é‡: $BASE_PATH"
          pnpm build
        env:
          # Project site path: https://<user>.github.io/vedarublog.github.io/
          BASE_PATH: "/vedarublog.github.io/"
          PUBLIC_URL: "https://${{ github.repository_owner }}.github.io/vedarublog.github.io"

      - name: Verify build output
        run: |-
          echo "=== éªŒè¯æ„å»ºè¾“å‡º ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "distç›®å½•å†…å®¹:"
          ls -la dist/
          echo ""
          echo "æ£€æŸ¥ index.html:"
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(du -h dist/index.html | cut -f1)"
            echo "å‰5è¡Œå†…å®¹:"
            head -5 dist/index.html
          else
            echo "âŒ index.html ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾HTMLæ–‡ä»¶:"
            find . -name "*.html" -type f
            # åˆ›å»ºä¸´æ—¶ index.html
            echo "åˆ›å»ºä¸´æ—¶ index.html..."
            mkdir -p dist
            cat > dist/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Vedaru Blog - éƒ¨ç½²æˆåŠŸ</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, 0x667eea 0%, 0x764ba2 100%); min-height: 100vh; color: white; text-align: center; }
                  .container { max-width: 800px; margin: 100px auto; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); }
                  h1 { font-size: 3em; margin-bottom: 20px; }
                  .url { background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 10px; display: inline-block; margin: 20px 0; font-family: monospace; font-size: 1.2em; }
                  .success { color: 0x4ade80; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸš€ éƒ¨ç½²æˆåŠŸï¼</h1>
                  <p class="success">GitHub Pages å·¥ä½œæ­£å¸¸</p>
                  <p>Astro é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°</p>
                  <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/</div>
                  <p>å¦‚æœè¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯·æ£€æŸ¥ï¼š</p>
                  <ul style="text-align: left; display: inline-block;">
                      <li>1. Astro æ„å»ºé…ç½®æ˜¯å¦æ­£ç¡®</li>
                      <li>2. æ˜¯å¦æœ‰ .astro é¡µé¢æ–‡ä»¶</li>
                      <li>3. æ„å»ºæ˜¯å¦ç”Ÿæˆå®é™…å†…å®¹</li>
                  </ul>
                  <p style="margin-top: 30px;">æ„å»ºæ—¶é—´: <span id="time"></span></p>
                  <script>
                      document.getElementById('time').textContent = new Date().toLocaleString('zh-CN');
                  </script>
              </div>
          </body>
          </html>
          HTMLEOF
            echo "ä¸´æ—¶ index.html å·²åˆ›å»º"
          fi
      
      - name: Create .nojekyll file
        run: |
          touch dist/.nojekyll
          echo "âœ… åˆ›å»ºäº† .nojekyll æ–‡ä»¶"

      - name: Create 404 page for GitHub Pages
        run: |
          if [ -f "dist/index.html" ]; then
            cp dist/index.html dist/404.html
            echo "âœ… åˆ›å»ºäº† 404.html æ–‡ä»¶"
          else
            echo "âš ï¸ index.html ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º 404.html"
          fi

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display deployment info
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "=== ç½‘ç«™ä¿¡æ¯ ==="
          echo "ğŸŒ ä¸»è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ”— GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "=== éƒ¨ç½²è¯¦æƒ… ==="
          echo "ğŸ“ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: pnpm"
          echo "ğŸ¯ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          echo "ğŸ’¡ æç¤º:"
          echo "1. é¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦ç­‰å¾…1-2åˆ†é’Ÿç¼“å­˜æ›´æ–°"
          echo "2. å¦‚æœçœ‹åˆ°404ï¼Œè¯·å°è¯•å¼ºåˆ¶åˆ·æ–° (Ctrl+F5 æˆ– Cmd+Shift+R)"
          echo "3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰èµ„æºåŠ è½½é”™è¯¯"