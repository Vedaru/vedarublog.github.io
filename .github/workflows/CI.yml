name: Deploy Astro to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  check:
    name: Astro Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
          run_install: true  # ç¡®ä¿å®‰è£… pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable corepack (makes pnpm available to cache step)
        run: corepack enable

      - name: Verify pnpm installation
        run: |
          echo "PNPMç‰ˆæœ¬:"
          pnpm --version
          echo "Nodeç‰ˆæœ¬:"
          node --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Astro Check
        run: pnpm astro check
        env:
          ENABLE_CONTENT_SYNC: false

  build-and-deploy:
    name: Build and Deploy
    needs: check
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
          run_install: true  # ç¡®ä¿å®‰è£… pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable corepack (makes pnpm available to cache step)
        run: corepack enable

      - name: Verify pnpm installation
        run: |
          echo "PNPMç‰ˆæœ¬:"
          pnpm --version
          echo "Nodeç‰ˆæœ¬:"
          node --version
          echo "å½“å‰ç›®å½•:"
          pwd
          ls -la

      - name: Install dependencies
        run: |
          echo "å®‰è£…ä¾èµ–..."
          pnpm install --frozen-lockfile
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run Astro Build
        run: |
          echo "å¼€å§‹æ„å»º Astro é¡¹ç›®..."
          echo "ä»“åº“å: ${{ github.event.repository.name }}"
          echo "BASE_PATH ç¯å¢ƒå˜é‡: $BASE_PATH"
          pnpm astro build
        env:
          # Project site path: https://<user>.github.io/vedarublog.github.io/
          BASE_PATH: "/vedarublog.github.io/"
          PUBLIC_URL: "https://${{ github.repository_owner }}.github.io/vedarublog.github.io"

      - name: Verify build output
        run: |-
          echo "=== éªŒè¯æ„å»ºè¾“å‡º ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "distç›®å½•å†…å®¹:"
          ls -la dist/
          echo ""
          echo "æ£€æŸ¥ index.html:"
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(du -h dist/index.html | cut -f1)"
            echo "å‰5è¡Œå†…å®¹:"
            head -5 dist/index.html
          else
            echo "âŒ index.html ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾HTMLæ–‡ä»¶:"
            find . -name "*.html" -type f
            # åˆ›å»ºä¸´æ—¶ index.html
            echo "åˆ›å»ºä¸´æ—¶ index.html..."
            mkdir -p dist
            cat > dist/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Vedaru Blog - éƒ¨ç½²æˆåŠŸ</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, 0x667eea 0%, 0x764ba2 100%); min-height: 100vh; color: white; text-align: center; }
                  .container { max-width: 800px; margin: 100px auto; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); }
                  h1 { font-size: 3em; margin-bottom: 20px; }
                  .url { background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 10px; display: inline-block; margin: 20px 0; font-family: monospace; font-size: 1.2em; }
                  .success { color: 0x4ade80; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸš€ éƒ¨ç½²æˆåŠŸï¼</h1>
                  <p class="success">GitHub Pages å·¥ä½œæ­£å¸¸</p>
                  <p>Astro é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°</p>
                  <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/</div>
                  <p>å¦‚æœè¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯·æ£€æŸ¥ï¼š</p>
                  <ul style="text-align: left; display: inline-block;">
                      <li>1. Astro æ„å»ºé…ç½®æ˜¯å¦æ­£ç¡®</li>
                      <li>2. æ˜¯å¦æœ‰ .astro é¡µé¢æ–‡ä»¶</li>
                      <li>3. æ„å»ºæ˜¯å¦ç”Ÿæˆå®é™…å†…å®¹</li>
                  </ul>
                  <p style="margin-top: 30px;">æ„å»ºæ—¶é—´: <span id="time"></span></p>
                  <script>
                      document.getElementById('time').textContent = new Date().toLocaleString('zh-CN');
                  </script>
              </div>
          </body>
          </html>
          HTMLEOF
            echo "ä¸´æ—¶ index.html å·²åˆ›å»º"
          fi
      
      - name: Create .nojekyll file
        run: |
          touch dist/.nojekyll
          echo "âœ… åˆ›å»ºäº† .nojekyll æ–‡ä»¶"

      - name: Create 404 page for GitHub Pages
        run: |
          if [ -f "dist/index.html" ]; then
            cp dist/index.html dist/404.html
            echo "âœ… åˆ›å»ºäº† 404.html æ–‡ä»¶"
          else
            echo "âš ï¸ index.html ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º 404.html"
          fi

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display deployment info
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "=== ç½‘ç«™ä¿¡æ¯ ==="
          echo "ğŸŒ ä¸»è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ”— GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "=== éƒ¨ç½²è¯¦æƒ… ==="
          echo "ğŸ“ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: pnpm"
          echo "ğŸ¯ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          echo "ğŸ’¡ æç¤º:"
          echo "1. é¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦ç­‰å¾…1-2åˆ†é’Ÿç¼“å­˜æ›´æ–°"
          echo "2. å¦‚æœçœ‹åˆ°404ï¼Œè¯·å°è¯•å¼ºåˆ¶åˆ·æ–° (Ctrl+F5 æˆ– Cmd+Shift+R)"
          echo "3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰èµ„æºåŠ è½½é”™è¯¯"
