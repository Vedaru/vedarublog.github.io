name: Deploy Astro to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  check:
    name: Astro Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Astro Check
        run: pnpm astro check
        env:
          ENABLE_CONTENT_SYNC: false

  build-and-deploy:
    name: Build and Deploy
    needs: check
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Astro Build
        run: |
          # è®¾ç½®åŸºç¡€è·¯å¾„ï¼ˆé‡è¦ï¼ï¼‰
          echo "GITHUB_REPOSITORY=${{ github.repository }}"
          echo "GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}"
          echo "BASE_PATH=/${{ github.event.repository.name }}/"
          pnpm astro build
        env:
          # è®¾ç½®åŸºç¡€è·¯å¾„ï¼Œç¡®ä¿é™æ€èµ„æºæ­£ç¡®å¼•ç”¨
          BASE_PATH: "/${{ github.event.repository.name }}/"
          PUBLIC_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: Verify build output
        run: |
          echo "=== éªŒè¯æ„å»ºè¾“å‡º ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "distç›®å½•å†…å®¹:"
          ls -la dist/
          echo ""
          echo "æ£€æŸ¥ index.html:"
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < dist/index.html) è¡Œ"
          else
            echo "âŒ index.html ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾HTMLæ–‡ä»¶:"
            find . -name "*.html" -type f
            exit 1
          fi
      
      - name: Create .nojekyll file
        run: |
          touch dist/.nojekyll
          echo "åˆ›å»ºäº† .nojekyll æ–‡ä»¶"

      - name: Create 404 page for GitHub Pages
        run: |
          if [ -f "dist/index.html" ]; then
            cp dist/index.html dist/404.html
            echo "åˆ›å»ºäº† 404.html æ–‡ä»¶"
          fi

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display deployment info
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "=== ç½‘ç«™ä¿¡æ¯ ==="
          echo "ğŸŒ ä¸»è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ”— GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "=== éƒ¨ç½²è¯¦æƒ… ==="
          echo "ğŸ“ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ¯ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          echo "ğŸ’¡ æç¤º: é¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦ç­‰å¾…1-2åˆ†é’Ÿç¼“å­˜æ›´æ–°"
          echo "        å¦‚æœçœ‹åˆ°404ï¼Œè¯·å°è¯•å¼ºåˆ¶åˆ·æ–° (Ctrl+F5)"
