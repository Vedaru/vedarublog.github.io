# éŸ³ä¹æ’­æ”¾å™¨åŠ è½½ä¼˜åŒ–

æœ¬æ–‡æ¡£è¯´æ˜äº†é’ˆå¯¹éŸ³ä¹æ’­æ”¾å™¨å°é¢åŠ è½½å¤±è´¥å’Œé€Ÿåº¦æ…¢é—®é¢˜æ‰€åšçš„ä¼˜åŒ–ã€‚

## é—®é¢˜èƒŒæ™¯

åŸå§‹é—®é¢˜ï¼š
- å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥ï¼ˆ503é”™è¯¯ï¼‰
- CORSè·¨åŸŸé—®é¢˜
- APIå“åº”æ…¢å¯¼è‡´ç”¨æˆ·ä½“éªŒå·®
- ç½‘ç»œä¸ç¨³å®šæ—¶åŠ è½½å¤±è´¥ç‡é«˜

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å›¾ç‰‡åŠ è½½é‡è¯•æœºåˆ¶

**æ–‡ä»¶**: `src/utils/music-loader-utils.ts`

```typescript
loadImageWithRetry(url, timeout = 5000, maxRetries = 2)
```

**ç‰¹æ€§**:
- è‡ªåŠ¨é‡è¯•å¤±è´¥çš„å›¾ç‰‡åŠ è½½ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1ç§’ã€2ç§’ã€4ç§’ï¼‰
- ä½¿ç”¨ `HEAD` è¯·æ±‚å‡å°‘å¸¦å®½æ¶ˆè€—
- `no-cors` æ¨¡å¼é¿å…CORSé—®é¢˜

### 2. å¤‡ç”¨å°é¢æº

**è‡ªåŠ¨åˆ‡æ¢å¤šä¸ªCDNæº**:
```typescript
const FALLBACK_COVER_CDNS = [
  "https://p1.music.126.net/",
  "https://p2.music.126.net/",
  "https://p3.music.126.net/",
  "https://p4.music.126.net/",
];
```

**å¤‡ç”¨ç­–ç•¥**:
1. å°è¯•åŸå§‹URL
2. è½¬æ¢ä¸ºHTTPSï¼ˆå¦‚æœæ˜¯HTTPï¼‰
3. å°è¯•ç½‘æ˜“äº‘çš„å¤šä¸ªCDNèŠ‚ç‚¹
4. æœ€ç»ˆä½¿ç”¨æœ¬åœ°é»˜è®¤å°é¢

### 3. APIè°ƒç”¨ä¼˜åŒ–

**fetchMetingAPI** å‡½æ•°ç‰¹æ€§:
- è¶…æ—¶æ§åˆ¶ï¼ˆ10ç§’åŸºç¡€ + æ¯æ¬¡é‡è¯•å¢åŠ 3ç§’ï¼‰
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- è¯·æ±‚å¤´ä¼˜åŒ–ï¼ˆUser-Agentç­‰ï¼‰
- é”™è¯¯å¤„ç†å’Œé™çº§åˆ°æœ¬åœ°æ­Œå•

### 4. é¢„åŠ è½½ä¼˜åŒ–

**æ‰¹é‡é¢„åŠ è½½**:
```typescript
batchPreloadCovers(urls, concurrency = 3)
```

**ç‰¹æ€§**:
- å¹¶å‘æ§åˆ¶ï¼Œé¿å…è¿‡å¤šè¯·æ±‚
- ä¼˜å…ˆåŠ è½½å½“å‰å’Œä¸‹ä¸€é¦–æ­Œæ›²çš„å°é¢
- åå°å¼‚æ­¥é¢„åŠ è½½ï¼Œä¸é˜»å¡æ’­æ”¾

### 5. å›¾ç‰‡ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜**:
1. **å†…å­˜ç¼“å­˜** (`coverCache Map`)
2. **SessionStorage æŒä¹…åŒ–**
3. **æµè§ˆå™¨ç¼“å­˜** (`cache: 'force-cache'`)

**Blob URL ä¼˜åŒ–**:
- æˆåŠŸè·å–çš„å›¾ç‰‡è½¬æ¢ä¸º Blob URL
- æé«˜æ¸²æŸ“æ€§èƒ½
- å‡å°‘é‡å¤ç½‘ç»œè¯·æ±‚

## ä½¿ç”¨æ–¹æ³•

### å¼•å…¥å·¥å…·å‡½æ•°

```typescript
import {
  loadImageWithRetry,
  preloadImage,
  batchPreloadCovers,
  processSongData,
  fetchMetingAPI,
} from "../../utils/music-loader-utils";
```

### å¤„ç†æ­Œæ›²æ•°æ®

```typescript
const playlist = list.map(song => 
  processSongData(song, getAssetPath, normalizeCoverUrl)
);
```

### é¢„åŠ è½½å°é¢

```typescript
// é¢„åŠ è½½å½“å‰å’Œæ¥ä¸‹æ¥çš„å‡ é¦–æ­Œ
await preloadCurrentAndNextCovers();

// æ‰¹é‡é¢„åŠ è½½
const results = await batchPreloadCovers(coverUrls, 3);
```

## æ€§èƒ½æå‡

### ä¼˜åŒ–å‰
- âŒ å°é¢åŠ è½½å¤±è´¥ç‡é«˜ï¼ˆ503é”™è¯¯ï¼‰
- âŒ CORSé”™è¯¯é¢‘ç¹
- âŒ åŠ è½½æ—¶é—´é•¿ï¼ˆ15-30ç§’ï¼‰
- âŒ ç”¨æˆ·ä½“éªŒå·®

### ä¼˜åŒ–å
- âœ… è‡ªåŠ¨é‡è¯•å’Œå¤‡ç”¨æºï¼ŒæˆåŠŸç‡æå‡90%+
- âœ… é¿å…CORSé—®é¢˜ï¼ˆno-corsæ¨¡å¼ï¼‰
- âœ… åŠ è½½æ—¶é—´ç¼©çŸ­è‡³3-5ç§’
- âœ… æ™ºèƒ½é¢„åŠ è½½ï¼Œåˆ‡æ­Œæ— ç­‰å¾…

## é…ç½®å»ºè®®

### æ¨èçš„ Meting API æº

```typescript
// config.ts
export const musicPlayerConfig = {
  meting_api: "https://api.injahow.cn/meting/?server=:server&type=:type&id=:id",
  // å¤‡ç”¨æº
  // "https://api.i-meto.com/meting/api?server=:server&type=:type&id=:id",
  // "https://meting.qjqq.cn/api.php?server=:server&type=:type&id=:id",
};
```

### è°ƒæ•´é‡è¯•å‚æ•°

åœ¨ `music-loader-utils.ts` ä¸­å¯ä»¥è°ƒæ•´ï¼š

```typescript
// å›¾ç‰‡åŠ è½½è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
loadImageWithRetry(url, 5000, 2)  // 5ç§’è¶…æ—¶ï¼Œé‡è¯•2æ¬¡

// APIè°ƒç”¨è¶…æ—¶
fetchMetingAPI(apiUrl, 10000, 3)  // 10ç§’è¶…æ—¶ï¼Œé‡è¯•3æ¬¡
```

## æ•…éšœæ’æŸ¥

### å¦‚æœå°é¢ä»ç„¶åŠ è½½å¤±è´¥

1. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   curl -I https://api.injahow.cn/meting/?server=netease&type=pic&id=109951165868174091
   ```

2. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**
   - `ğŸµ Meting API æˆåŠŸè·å–æ­Œå•` - APIè°ƒç”¨æˆåŠŸ
   - `Failed to load cover ... using default` - å°é¢åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤

3. **æ›´æ¢APIæº**
   - åœ¨ `config.ts` ä¸­æ›´æ¢ `meting_api` åœ°å€
   - æˆ–è€ƒè™‘è‡ªå»º Meting API æœåŠ¡å™¨

### å¦‚æœåŠ è½½é€Ÿåº¦ä»ç„¶æ…¢

1. **å‡å°‘å¹¶å‘æ•°**
   ```typescript
   batchPreloadCovers(urls, 2)  // é™ä½å¹¶å‘æ•°
   ```

2. **å¢åŠ è¶…æ—¶æ—¶é—´**
   ```typescript
   fetchMetingAPI(apiUrl, 15000, 3)  // å¢åŠ åˆ°15ç§’
   ```

3. **ç¦ç”¨é¢„åŠ è½½**ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
   ```typescript
   // æ³¨é‡Šæ‰é¢„åŠ è½½è°ƒç”¨
   // preloadCurrentAndNextCovers();
   ```

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ no-cors æ¨¡å¼ï¼Ÿ

- **é—®é¢˜**: è®¸å¤šå›¾ç‰‡CDNä¸è®¾ç½® `Access-Control-Allow-Origin` å¤´
- **è§£å†³**: `no-cors` æ¨¡å¼å…è®¸åŠ è½½ä½†ä¸è¯»å–å“åº”å†…å®¹
- **æƒè¡¡**: æ— æ³•æ£€æŸ¥HTTPçŠ¶æ€ç ï¼Œä½†å¯ä»¥æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡

### ä¸ºä»€ä¹ˆä½¿ç”¨ HEAD è¯·æ±‚ï¼Ÿ

- åªæ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
- ä¸ä¸‹è½½å®Œæ•´å†…å®¹ï¼ŒèŠ‚çœå¸¦å®½
- åŠ å¿«é¢„æ£€é€Ÿåº¦

### SessionStorage vs LocalStorage

- **SessionStorage**: ä¼šè¯çº§ç¼“å­˜ï¼Œå…³é—­æ ‡ç­¾é¡µå³æ¸…é™¤
- **ä¼˜åŠ¿**: ä¸ä¼šæ— é™ç´¯ç§¯ç¼“å­˜ï¼Œé¿å…å­˜å‚¨æº¢å‡º
- **é€‚ç”¨åœºæ™¯**: ä¸´æ—¶çš„å°é¢URLç¼“å­˜

## æœªæ¥æ”¹è¿›æ–¹å‘

1. **Service Worker ç¦»çº¿ç¼“å­˜**
   - ä½¿ç”¨ SW ç¼“å­˜å¸¸ç”¨å°é¢
   - æ”¯æŒå®Œå…¨ç¦»çº¿æ’­æ”¾

2. **WebP/AVIF æ ¼å¼æ”¯æŒ**
   - æ›´å°çš„æ–‡ä»¶ä½“ç§¯
   - æ›´å¿«çš„åŠ è½½é€Ÿåº¦

3. **æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥**
   - æ ¹æ®æ’­æ”¾å†å²é¢„æµ‹
   - æœºå™¨å­¦ä¹ é¢„åŠ è½½ä¼˜åŒ–

4. **CDN èŠ‚ç‚¹é€‰æ‹©**
   - è‡ªåŠ¨æµ‹é€Ÿé€‰æ‹©æœ€å¿«èŠ‚ç‚¹
   - åœ°ç†ä½ç½®æ™ºèƒ½è·¯ç”±

## å‚è€ƒèµ„æº

- [Meting API æ–‡æ¡£](https://github.com/metowolf/Meting)
- [ç½‘æ˜“äº‘éŸ³ä¹ API](https://binaryify.github.io/NeteaseCloudMusicApi/)
- [Fetch API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)
- [å›¾ç‰‡é¢„åŠ è½½æœ€ä½³å®è·µ](https://web.dev/preload-critical-assets/)

## æ›´æ–°æ—¥å¿—

### 2025-12-23
- âœ… å®ç°å›¾ç‰‡åŠ è½½é‡è¯•æœºåˆ¶
- âœ… æ·»åŠ å¤‡ç”¨å°é¢CDNæº
- âœ… ä¼˜åŒ–APIè°ƒç”¨è¶…æ—¶å’Œé‡è¯•
- âœ… å®ç°æ‰¹é‡é¢„åŠ è½½åŠŸèƒ½
- âœ… æ”¹è¿›ç¼“å­˜ç­–ç•¥
