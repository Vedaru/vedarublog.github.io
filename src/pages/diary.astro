---
import { siteConfig } from "../config";
import { getDiaryList, getDiaryStats } from "../data/diary";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥æ—¥è®°é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.diary) {
	return Astro.redirect("/404/");
}

// è·å–æ—¥è®°æ•°æ®
const moments = getDiaryList();
const diaryStats = getDiaryStats();

// Build grouped year->month structure for TOC and anchor mapping
const groupedMoments = {} as Record<string, Record<string, typeof moments>>;
const monthAnchorMap: Record<number, string> = {};
for (const m of moments) {
	const d = new Date(m.date);
	const y = String(d.getFullYear());
	const month = String(d.getMonth() + 1).padStart(2, "0");
	if (!groupedMoments[y]) groupedMoments[y] = {};
	if (!groupedMoments[y][month]) groupedMoments[y][month] = [];
	groupedMoments[y][month].push(m);
}
// For each year/month, map the first moment of that month to an anchor id
for (const [y, months] of Object.entries(groupedMoments)) {
	for (const [month, items] of Object.entries(months)) {
		if (items.length > 0) {
			const anchorId = `year-${y}-month-${month}`;
			monthAnchorMap[items[0].id] = anchorId; // first item for that month
		}
	}
}

// Build a sorted grouped structure (years desc, months desc, items desc)
const sortedGroupedMoments = {} as Record<string, Record<string, typeof moments>>;
const yearKeys = Object.keys(groupedMoments).sort((a, b) => parseInt(b) - parseInt(a));
const sortedYearKeys = yearKeys; // keep explicit array (object keys may reorder numeric-like keys)
const sortedMonthKeysByYear: Record<string, string[]> = {};
for (const y of yearKeys) {
	const months = groupedMoments[y];
	const monthKeys = Object.keys(months).sort((a, b) => parseInt(b) - parseInt(a));
	sortedMonthKeysByYear[y] = monthKeys;
	sortedGroupedMoments[y] = {};
	for (const m of monthKeys) {
		sortedGroupedMoments[y][m] = months[m].slice().sort((x, y) => new Date(y.date).getTime() - new Date(x.date).getTime());
	}
}

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
	<!-- å¼•å…¥å³ä¾§è¾¹æ å¸ƒå±€ç®¡ç†å™¨ -->
  <script>
    import('../scripts/right-sidebar-layout.js');
  </script>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
		<div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
		<div class="relative max-w-4xl w-full px-2 md:px-0">
				<!-- é¡µé¢å¤´éƒ¨ -->
				<div class="moments-header mb-6">
					<div class="header-content">
						<div class="header-info">
							<h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">{i18n(I18nKey.diary)}</h1>
							<p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">{i18n(I18nKey.diarySubtitle)}</p>
						</div>
						<div class="header-stats">
							<div class="stat-item text-center">
								<span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]">{diaryStats.total}</span>
								<span class="stat-label text-xs md:text-sm lg:text-base text-75">{i18n(I18nKey.diaryCount)}</span>
							</div>
						</div>
					</div>
				</div>

				<!-- çŸ­æ–‡åˆ—è¡¨ -->

					<div class="moments-timeline">
						<div class="timeline-list space-y-4">
{sortedYearKeys.map((year) => (
						<>
							<h1 id={`year-${year}`} class="diary-year-heading mt-2 mb-4 text-xl font-semibold text-90 dark:text-20">{year} å¹´</h1>
							{sortedMonthKeysByYear[year].map((month) => (
								<>
									<h2 id={`year-${year}-month-${month}`} class="diary-month-heading mt-1 mb-3 text-md font-medium text-70 dark:text-40">{month} æœˆ</h2>
									{sortedGroupedMoments[year][month].map((moment) => (
											<div id={monthAnchorMap[moment.id] ?? undefined} class="moment-item card-base-daily p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
												<div class="moment-content">
													<p class="moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4">{moment.content}</p>
													{moment.images && moment.images.length > 0 && (
													<div class="diary-images grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 lg:gap-4 mb-3 md:mb-4">
														{moment.images.map((image, _index) => (
														<div class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform">
															<a href="javascript:void(0)" data-src={image} data-fancybox={`gallery-${moment.id}-${_index}`} class="block w-full h-full">
																<img 
																src={image} 
																alt="diary moment image"
																class="w-full h-full object-cover"
																loading="lazy"
															/>
															</a>
														</div>
													))}
													</div>
												)}
											</div>
											<hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />
											<div class="moment-footer flex justify-between items-center">
												<div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
													<i class="time-icon text-xs md:text-sm">ğŸ•</i>
													<time datetime={moment.date}>
														{(() => {
															const d = new Date(moment.date);
															const m = d.getMonth() + 1;
															const day = d.getDate();
															return `${m}æœˆ${day}æ—¥`;
														})()}
													</time>
												</div>
											</div>
										</div>
									))}
								</>
							))}
						</>
						))}
					</div>


				<!-- åº•éƒ¨æç¤º -->
				<div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
					{i18n(I18nKey.diaryTips)}
				</div>
			</div>
		</div>
	</div>
</MainGridLayout>

<style>
	.card-base-daily {
		@apply rounded-[var(--radius-large)] overflow-hidden bg-[var(--card-bg)];
		border: 1px solid var(--line-divider);
		transition: all 0.3s ease;
	}
	
	.moments-header {
		padding: 1rem;
		border-radius: 8px;
		background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
		color: white;
		position: relative;
		overflow: hidden;
	}
	
	.header-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: relative;
		z-index: 1;
	}
	
	.moments-title {
		color: white;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}
	
	.moments-subtitle {
		color: rgba(255, 255, 255, 0.9);
	}
	
	.stat-number {
		color: white;
	}
	
	.stat-label {
		color: rgba(255, 255, 255, 0.8);
	}
	
	.image-item img {
		transition: transform 0.3s ease;
	}
	
	.image-item:hover img {
		transform: scale(1.05);
	}
	
	.action-btn {
		background: none;
		border: none;
		cursor: pointer;
		color: var(--text-muted);
	}
	
	.action-btn:hover {
		color: var(--primary);
	}
	
	/* å“åº”å¼è®¾è®¡ */
	/* æ‰‹æœºç«¯ (å°äº640px) */
	@media (max-width: 640px) {
		.moments-header {
			padding: 0.75rem;
		}
		
		.header-content {
			flex-direction: column;
			text-align: center;
			gap: 0.75rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(2, 1fr);
		}
		
		.moment-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}
	}
	
	/* å¹³æ¿ç«–å± (641px - 900px) - ä¼˜åŒ–æ˜¾ç¤º */
	@media (min-width: 641px) and (max-width: 900px) {
		.moments-header {
			padding: 1.25rem;
		}
		
		.header-content {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.moment-item {
			padding: 1.5rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(3, 1fr);
			gap: 0.75rem;
			max-width: 500px;
		}
		
		.moment-text {
			font-size: 1rem;
			line-height: 1.7;
		}
		
		.moment-footer {
			margin-top: 1rem;
		}
	}
	
	/* å¹³æ¿æ¨ªå±å’Œæ¡Œé¢ç«¯ (å¤§äº900px) */
	@media (min-width: 901px) {
		.moments-header {
			padding: 1.5rem;
		}
		
		.moment-item {
			padding: 2rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			max-width: 600px;
			gap: 1rem;
		}
		
		.moment-text {
			font-size: 1.1rem;
			line-height: 1.8;
		}
	}
	
	/* ä¼˜åŒ–å°å±å¹•æ˜¾ç¤º */
	@media (max-width: 480px) {
		.moment-item {
			border-radius: 8px;
		}
		
		.moments-header {
			border-radius: 6px;
		}
	}

/* å¹´/æœˆæ ‡é¢˜æ·±è‰²æ¨¡å¼é€‚é…ï¼ˆå¢å¼ºï¼‰ */
.diary-year-heading {
	@apply text-black/90;
}
.dark .diary-year-heading {
	@apply text-white/90;
}
.diary-month-heading {
	@apply text-black/90;
}
.dark .diary-month-heading {
	@apply text-white/90;
}
</style>


