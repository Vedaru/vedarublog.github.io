---
// ä¼˜åŒ–çš„ç•ªå‰§å¡ç‰‡ç»„ä»¶ï¼ŒåŒ…å«å›¾ç‰‡æ‡’åŠ è½½å’Œé¢„åŠ è½½åŠŸèƒ½
interface Props {
	anime: {
		title: string;
		status: "watching" | "completed" | "planned" | "onhold" | "dropped";
		rating: number;
		cover: string;
		description: string;
		episodes: string;
		year: string;
		genre: string[];
		studio: string;
		postUrl?: string;
		progress: number;
		totalEpisodes: number;
		startDate: string;
		endDate: string;
	};
	index: number;
}

const { anime, index } = Astro.props;

// çŠ¶æ€ä¿¡æ¯æ˜ å°„
const statusMap = {
	watching: { text: "è§‚çœ‹ä¸­", icon: "â–¶ï¸", class: "bg-emerald-500/90 text-white" },
	completed: { text: "å·²å®Œæˆ", icon: "âœ…", class: "bg-blue-500/90 text-white" },
	planned: { text: "è®¡åˆ’ä¸­", icon: "ğŸ“…", class: "bg-purple-500/90 text-white" },
	onhold: { text: "æš‚åœä¸­", icon: "â¸ï¸", class: "bg-yellow-500/90 text-white" },
	dropped: { text: "å·²æ”¾å¼ƒ", icon: "âŒ", class: "bg-red-500/90 text-white" },
};

const statusInfo = statusMap[anime.status];
const progressPercent = anime.totalEpisodes > 0 ? (anime.progress / anime.totalEpisodes) * 100 : 0;

// å‰å‡ ä¸ªå¡ç‰‡ä½¿ç”¨ä¼˜å…ˆåŠ è½½ï¼Œåé¢çš„ä½¿ç”¨æ‡’åŠ è½½
const isPriority = index < 6;
---

<a
	href={anime.postUrl}
	target={anime.postUrl ? "_self" : "_blank"}
	rel={anime.postUrl ? "" : "noopener noreferrer"}
	class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden transition-all duration-300 hover:shadow-lg hover:scale-[1.02] block anime-card"
	data-anime-status={anime.status}
>
	<!-- å°é¢åŒºåŸŸ - ç«–å±æ¯”ä¾‹ -->
	<div class="relative aspect-[2/3] overflow-hidden">
		<div class="block w-full h-full">
			<!-- ä½¿ç”¨ä¼˜åŒ–çš„å›¾ç‰‡åŠ è½½ï¼šå‰è‹¥å¹²å¼ ä¸ºä¼˜å…ˆåŠ è½½ï¼Œå…¶ä½™ä½¿ç”¨å ä½å›¾ + data-src æ‡’åŠ è½½ -->
			{isPriority ? (
				<img
					src={anime.cover}
					alt={anime.title}
					class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
					loading="eager"
					decoding="async"
					fetchpriority="high"
				/>
			) : (
				<img
					src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
					data-src={anime.cover}
					alt={anime.title}
					class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
					loading="lazy"
					decoding="async"
				/>
			)}
			<!-- æ¸å˜é®ç½© -->
			<div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
			</div>
		</div>

		<!-- çŠ¶æ€æ ‡ç­¾ -->
		<div class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}>
			<span class="mr-1">{statusInfo.icon}</span>
			<span>{statusInfo.text}</span>
		</div>

		<!-- è¯„åˆ† -->
		<div class="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1">
			<svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
				<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
			</svg>
			<span>{anime.rating}</span>
		</div>

		<!-- è¿›åº¦æ¡ - åœ¨å°é¢åº•éƒ¨ -->
		{anime.status === 'watching' && (
			<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
				<div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
					<div class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300" style={`width: ${progressPercent}%`}></div>
				</div>
				<div class="text-white text-xs font-medium">
					{anime.progress}/{anime.totalEpisodes} ({Math.round(progressPercent)}%)
				</div>
			</div>
		)}
	</div>

	<!-- ä¿¡æ¯åŒºåŸŸ -->
	<div class="p-4">
		<!-- æ ‡é¢˜ -->
		<h3 class="font-semibold text-[var(--text-primary)] mb-2 line-clamp-2 group-hover:text-[var(--primary)] transition-colors duration-200">
			{anime.title}
		</h3>

		<!-- åŸºæœ¬ä¿¡æ¯ -->
		<div class="space-y-1 text-sm text-[var(--text-secondary)]">
			<div class="flex items-center gap-2">
				<span class="text-xs">ğŸ“…</span>
				<span>{anime.year}</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-xs">ğŸ¬</span>
				<span>{anime.studio}</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-xs">ğŸ“º</span>
				<span>{anime.episodes}</span>
			</div>
		</div>

		<!-- æ ‡ç­¾ -->
		{anime.genre && anime.genre.length > 0 && (
			<div class="flex flex-wrap gap-1 mt-3">
				{anime.genre.slice(0, 3).map(genre => (
					<span class="px-2 py-1 bg-[var(--btn-regular-bg)] text-[var(--text-secondary)] text-xs rounded-md">
						{genre}
					</span>
				))}
			</div>
		)}

		<!-- æè¿° -->
		{anime.description && (
			<p class="text-sm text-[var(--text-secondary)] mt-3 line-clamp-2">
				{anime.description}
			</p>
		)}
	</div>
</a>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	/* ä¼˜åŒ–å›¾ç‰‡åŠ è½½æ—¶çš„é—ªçƒ */
	.anime-card img {
		will-change: transform;
	}

	/* é¢„åŠ è½½å³å°†è¿›å…¥è§†å£çš„å›¾ç‰‡ */
	.anime-card[data-preload] img {
		loading: eager;
	}
</style>