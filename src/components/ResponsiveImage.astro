---
// Server-side component: use manifest generated by scripts/generate-responsive-images.js
import fs from 'fs';
import path from 'path';

interface Props {
  src: string;
  alt?: string;
  class?: string;
  sizes?: string;
  loading?: 'lazy' | 'eager';
  width?: number;
  height?: number;
  decoding?: 'async' | 'sync' | 'auto';
}

const { src, alt = '', class: cls = '', sizes = '100vw', loading = 'lazy', width, height, decoding = 'async' } = Astro.props as Props;

// Collect any other props to forward to the <img> element (e.g. data-*, fetchpriority)
const forwardedProps: Record<string, any> = {};
for (const key of Object.keys(Astro.props)) {
  if (!['src', 'alt', 'class', 'sizes', 'loading', 'width', 'height', 'decoding'].includes(key)) {
    forwardedProps[key] = (Astro.props as Record<string, any>)[key];
  }
}

let manifest: Record<string, any> = {};
const manifestPath = path.resolve('public', '_gen', 'manifest.json');
if (fs.existsSync(manifestPath)) {
  try {
    const raw = fs.readFileSync(manifestPath, 'utf-8');
    manifest = JSON.parse(raw);
  } catch (e) {
    // ignore, fall back to original
  }
}

const entry = manifest[src];
let srcset = '';
let fallback = src;
if (entry) {
  const variants = entry.variants || [];
  // assembly srcset using generated /_gen/ URLs
  srcset = variants.map((v) => `${v.src} ${v.width}w`).join(', ');
  fallback = entry.fallback || entry.original || src;
}
---

{/** Render an <img> with srcset/sizes if available */}
<img
  src={fallback}
  {...(srcset ? { srcset } : {})}
  sizes={srcset ? sizes : undefined}
  alt={alt}
  class={cls}
  loading={loading}
  decoding={decoding}
  width={width}
  height={height}
  style={"max-width:100%;height:auto;"}
  {...forwardedProps}
/>
