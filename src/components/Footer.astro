---

import * as fs from "node:fs";
import * as path from "node:path";
import { footerConfig, profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();

// 页脚自定义内容逻辑
let customFooterHtml = "";
if (footerConfig.enable) {
	// 优先使用 customHtml，如果为空则使用 FooterConfig.html 文件内容
	if (footerConfig.customHtml && footerConfig.customHtml.trim() !== "") {
		customFooterHtml = footerConfig.customHtml.trim();
	} else {
		// customHtml 为空时，读取 FooterConfig.html 文件内容
		try {
			const footerConfigPath = path.join(
				process.cwd(),
				"src",
				"FooterConfig.html",
			);
			customFooterHtml = fs.readFileSync(footerConfigPath, "utf-8");
			// 移除HTML注释
			customFooterHtml = customFooterHtml
				.replace(/<!--[\s\S]*?-->/g, "")
				.trim();
		} catch (error) {
			console.warn("FooterConfig.html文件读取失败:", error.message);
		}
	}
}
---

<!--<div class="border-t border-[var(&#45;&#45;primary)] mx-16 border-dashed py-8 max-w-[var(&#45;&#45;page-width)] flex flex-col items-center justify-center px-6">-->
<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"></div>
<!--<div class="transition bg-[oklch(92%_0.01_var(&#45;&#45;hue))] dark:bg-black rounded-2xl py-8 mt-4 mb-8 flex flex-col items-center justify-center px-6">-->
<div class="transition border-dashed border-[oklch(85%_0.01_var(--hue))] dark:border-white/15 rounded-2xl mb-12 flex flex-col items-center justify-center px-6">
    <div class="transition text-50 text-sm text-center">
        {customFooterHtml && (
            <div class="mb-2" set:html={customFooterHtml}></div>
        )}
        &copy; <span id="copyright-year">{currentYear}</span> {profileConfig.name}. All Rights Reserved. /
        <a class="transition link text-[var(--primary)] font-medium" href={url('rss/')} onclick={`event.preventDefault(); navigateToPage('${url('rss/')}')`}>RSS</a> /
		<a class="transition link text-[var(--primary)] font-medium" href={url('atom/')} onclick={`event.preventDefault(); navigateToPage('${url('atom/')}')`}>Atom</a> /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('sitemap-index.xml')}>Sitemap</a><br>
        Powered by
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> &
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/matsuzaka-yuki/mizuki">Mizuki</a>&nbsp; Version <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/matsuzaka-yuki/mizuki">7.6</a><br>
        <a id="sakura-trigger" class="transition link text-[var(--primary)] font-medium cursor-pointer" style="user-select: none;" href="javascript:void(0);" onclick="window.handleSakuraToggle?.(); return false;">点击一下什么都不会发生吧</a>
    </div>
</div>

<script is:inline>
    // 全局处理函数
    window.handleSakuraToggle = function() {
        console.log('=== 触发樱花切换 ===');
        console.log('window.__toggleSakura 存在:', typeof window.__toggleSakura);
        console.log('window.__getSakuraStatus 存在:', typeof window.__getSakuraStatus);
        console.log('window.__initSakura 存在:', typeof window.__initSakura);
        
        // 确保樱花管理器已初始化
        if (typeof window.__initSakura === 'function' && !window.__sakuraManagerCreated) {
            console.log('首次点击，初始化樱花管理器...');
            window.__initSakura();
            window.__sakuraManagerCreated = true;
        }
        
        if (typeof window.__toggleSakura === 'function') {
            try {
                window.__toggleSakura();
                const isRunning = typeof window.__getSakuraStatus === 'function' ? window.__getSakuraStatus() : false;
                console.log('樱花状态已切换:', isRunning ? '开启' : '关闭');
                
                const trigger = document.getElementById('sakura-trigger');
                if (trigger) {
                    if (isRunning) {
                        trigger.textContent = '再点一下试试';
                    } else {
                        trigger.textContent = '点击一下什么都不会发生吧';
                    }
                }
            } catch (error) {
                console.error('切换樱花时出错:', error);
            }
        } else {
            console.error('樱花管理器未加载，等待初始化...');
            // 延迟重试
            setTimeout(function() {
                if (typeof window.__toggleSakura === 'function') {
                    console.log('重试成功');
                    window.handleSakuraToggle();
                } else {
                    console.error('樱花管理器仍未加载');
                }
            }, 100);
        }
    };
    console.log('全局樱花处理函数已注册');
</script>

<script>
    import { toggleSakura, getSakuraStatus, initSakura } from '../utils/sakura-manager';
    import { sakuraConfig } from '../config';

    // 挂载到window对象
    (window as any).__toggleSakura = toggleSakura;
    (window as any).__getSakuraStatus = getSakuraStatus;
    
    // 挂载初始化函数
    (window as any).__initSakura = function() {
        if (!(window as any).sakuraInitialized) {
            // 使用enable:true来初始化管理器，这样toggle才能工作
            const config = { ...sakuraConfig, enable: true };
            initSakura(config);
            (window as any).sakuraInitialized = true;
            console.log('樱花管理器已完全初始化');
        }
    };
    
    console.log('樱花函数已挂载到window');
</script>
