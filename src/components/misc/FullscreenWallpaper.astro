---
import { siteConfig } from "../../config";
import type { FullscreenWallpaperConfig } from "../../types/config";
import ResponsiveImage from "../ResponsiveImage.astro";

interface Props {
	config: FullscreenWallpaperConfig;
	className?: string;
}

const { config, className } = Astro.props;

// 获取当前设备类型的图片源
const getImageSources = async () => {
	let srcConfig = config.src;

	// API 图片逻辑
	if (siteConfig.banner.imageApi?.enable && siteConfig.banner.imageApi?.url) {
		try {
			const response = await fetch(siteConfig.banner.imageApi.url);
			const text = await response.text();
			const apiImages = text.split("\n").filter((line) => line.trim());
			if (apiImages.length > 0) {
				return { desktop: apiImages, mobile: apiImages };
			}
		} catch (error) {
			console.warn("Failed to fetch images from API:", error);
		}
	}

	const toArray = (src: string | string[] | undefined): string[] => 
		Array.isArray(src) ? src : (typeof src === "string" ? [src] : []);

	if (typeof srcConfig === "object" && srcConfig !== null && !Array.isArray(srcConfig)) {
		const desktop = toArray(srcConfig.desktop);
		const mobile = toArray(srcConfig.mobile);
		return {
			desktop: desktop.length > 0 ? desktop : mobile,
			mobile: mobile.length > 0 ? mobile : desktop,
		};
	}

	// 如果是字符串或字符串数组，同时用于桌面端和移动端
	const allImages = toArray(srcConfig as string | string[]);
	return { desktop: allImages, mobile: allImages };
};

const imageSources = await getImageSources();
const hasDesktopImages = imageSources.desktop.length > 0;
const hasMobileImages = imageSources.mobile.length > 0;

if (!hasDesktopImages && !hasMobileImages) return null;

// 轮播配置
const isCarouselEnabled = config.carousel?.enable && 
	(imageSources.desktop.length > 1 || imageSources.mobile.length > 1);
const carouselInterval = config.carousel?.interval || 5;

// 样式配置
const position = config.position || "center";
const zIndex = config.zIndex || -1;
const opacity = config.opacity || 0.8;
const blur = config.blur || 0;
const positionClass = (() => {
	switch (position) {
		case "top": return "object-top";
		case "bottom": return "object-bottom";
		default: return "object-center";
	}
})();

const renderGroups = [
	{
		key: 'desktop',
		images: imageSources.desktop,
		containerClass: "hidden lg:block",
		hasImages: hasDesktopImages
	},
	{
		key: 'mobile',
		images: imageSources.mobile,
		containerClass: "block lg:hidden",
		hasImages: hasMobileImages
	}
];
---

<div 
	class:list={[
		"fixed inset-0 w-full h-full overflow-hidden pointer-events-none",
		className
	]}
	style={`z-index: ${zIndex}; opacity: ${opacity}; transform: translateZ(0); perspective: 1000px;`}
	data-fullscreen-wallpaper
>
	<script is:inline>
	// 立即执行脚本：防止闪烁
	(function() {
		// 默认行为改为全屏模式，避免首次渲染被隐藏
		const mode = localStorage.getItem('wallpaperMode') || 'fullscreen';
		if (mode !== 'fullscreen') {
			document.currentScript.parentElement.style.display = 'none';
		}
	})();
	</script>

	{renderGroups.map(group => group.hasImages && (
		<div class={`${group.containerClass} w-full h-full relative`} style="transform: translateZ(0);">
			{group.images.map((src, index) => (
				<ResponsiveImage
					src={src}
					alt={`${group.key} wallpaper ${index + 1}`}
					class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ${positionClass}`}
					data-carousel-item={isCarouselEnabled ? index : undefined}
					style={`transform: translateZ(0); backface-visibility: hidden; will-change: opacity; ${blur > 0 ? `filter: blur(${blur}px);` : ''}; opacity: ${index === 0 ? 1 : 0};`}
					decoding="async"
					loading={index === 0 ? "eager" : "lazy"}
					fetchpriority={index === 0 ? 'high' : undefined}
					/>
			))}
		</div>
	))}
</div>

{isCarouselEnabled && (
	<script is:inline define:vars={{ carouselInterval }}>
		function initFullscreenWallpaperCarousel() {
			const container = document.querySelector('[data-fullscreen-wallpaper]');
			if (!container) return;

			if (window.__wallpaper_cleanup) {
				window.__wallpaper_cleanup();
				window.__wallpaper_cleanup = null;
			}

			const STORAGE_KEY = 'mizuki_wallpaper_index';
			let savedIndex = parseInt(sessionStorage.getItem(STORAGE_KEY) || '0');

			const groups = [
				container.querySelectorAll('.hidden.lg\\:block [data-carousel-item]'),
				container.querySelectorAll('.block.lg\\:hidden [data-carousel-item]')
			];

			const state = groups.map(items => {
				const safeIndex = (savedIndex >= 0 && savedIndex < items.length) ? savedIndex : 0;
				return {
					items,
					currentIndex: safeIndex,
					timer: null,
					active: items.length > 1
				};
			});

			// 初始化显示：根据 savedIndex 立即修正图片显示
			function initImage(stateItem) {
				const { items, currentIndex } = stateItem;
				// 立即设置样式，防止视觉上跳回第一张
				for (let i = 0; i < items.length; i++) {
					// 优化加载策略：当前显示项设置为 eager 并提升优先级
					try {
						items[i].style.opacity = i === currentIndex ? '1' : '0';
						items[i].loading = i === currentIndex ? 'eager' : 'lazy';
						if (i === currentIndex) items[i].setAttribute('fetchpriority', 'high');
					} catch (e) {
						// ignore
					}
				}
			}

			// 预加载图片（返回一个 promise）
			function preloadImage(img) {
				return new Promise((resolve) => {
					const src = img.currentSrc || img.src;
					if (!src) return resolve();
					const pre = new Image();
					pre.src = src;
					if (pre.decode) {
						pre.decode().then(resolve).catch(resolve);
					} else {
						// no decode support, resolve immediately
						setTimeout(resolve, 50);
					}
				});
			}

			// 切换下一张
			async function switchNextImage(stateItem) {
				const { items, currentIndex } = stateItem;
				const nextIndex = (currentIndex + 1) % items.length;
				
				// 预加载下一张图以避免切换时出现空白
				try {
					await preloadImage(items[nextIndex]);
				} catch (e) {
					// ignore
				}
				
				items[currentIndex].style.opacity = '0';
				items[nextIndex].style.opacity = '1';
				
				stateItem.currentIndex = nextIndex;

				sessionStorage.setItem(STORAGE_KEY, nextIndex.toString());
			}

			function start() {
				state.forEach(s => {
					if (s.active && !s.timer) {
						s.timer = setInterval(() => {
							if (!document.body.contains(s.items[0])) {
								stop();
								return;
							}
							switchNextImage(s);
						}, carouselInterval * 1000);
					}
				});
			}

			function stop() {
				state.forEach(s => {
					if (s.timer) {
						clearInterval(s.timer);
						s.timer = null;
					}
				});
			}

			const handleVisibilityChange = () => {
				if (document.hidden) {
					stop();
				} else {
					const exists = state.some(s => s.items.length > 0 && document.body.contains(s.items[0]));
					if (exists) start();
				}
			};

			// 初始化状态
			state.forEach(s => {
				if (s.items.length > 0) initImage(s);
			});

			start();

			document.addEventListener('visibilitychange', handleVisibilityChange);

			window.__wallpaper_cleanup = () => {
				stop();
				document.removeEventListener('visibilitychange', handleVisibilityChange);
			};
		}

		// 页面加载完成后初始化轮播
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initFullscreenWallpaperCarousel);
		} else {
			initFullscreenWallpaperCarousel();
		}
	</script>
)}