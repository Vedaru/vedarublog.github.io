---
import { Icon } from "astro-icon/components";

interface DesktopIcon {
	id: string;
	label: string;
	icon?: string;
	iconName?: string; // Astro Icon name
	href?: string;
	onClick?: string; // JavaScript function name
}

interface Props {
	icons: DesktopIcon[];
	className?: string;
}

const { icons, className = "" } = Astro.props;
---

<div class={`desktop-icons ${className}`}>
	{
		icons.map((icon) => {
			const IconComponent = icon.href ? "a" : "div";
			return (
				<IconComponent
					class="desktop-icon"
					href={icon.href}
					data-icon-id={icon.id}
					data-onclick={icon.onClick}
				>
					{icon.icon ? (
						<img
							src={icon.icon}
							alt={icon.label}
							class="desktop-icon-image"
						/>
					) : icon.iconName ? (
						<div class="desktop-icon-image flex items-center justify-center">
							<Icon
								name={icon.iconName}
								class="text-[40px] text-white drop-shadow-lg"
							/>
						</div>
					) : (
						<div class="desktop-icon-image flex items-center justify-center bg-white/20 rounded">
							<Icon
								name="material-symbols:folder-outline"
								class="text-[40px] text-white"
							/>
						</div>
					)}
					<div class="desktop-icon-label">{icon.label}</div>
				</IconComponent>
			);
		})
	}
</div>

<script>
	function initDesktopIcons() {
		const icons = document.querySelectorAll(".desktop-icon");

		icons.forEach((icon) => {
			// 双击事件
			icon.addEventListener("dblclick", (e) => {
				e.preventDefault();
				const onclickFn = icon.getAttribute("data-onclick");
				if (onclickFn && typeof window[onclickFn] === "function") {
					window[onclickFn]();
				} else if (icon.getAttribute("href")) {
					window.location.href = icon.getAttribute("href")!;
				}
			});

			// 单击选中效果
			icon.addEventListener("click", (e) => {
				// 如果是双击的第二次点击，忽略
				if ((e as any).detail === 2) return;

				// 移除其他图标的选中状态
				icons.forEach((i) => i.classList.remove("selected"));
				// 添加当前图标的选中状态
				icon.classList.add("selected");
			});
		});

		// 点击桌面空白处取消选中
		const desktop = document.querySelector(".desktop-container");
		if (desktop) {
			desktop.addEventListener("click", (e) => {
				if (
					e.target === desktop ||
					(e.target as Element).classList.contains("desktop-content")
				) {
					icons.forEach((i) => i.classList.remove("selected"));
				}
			});
		}
	}

	// 页面加载时初始化
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initDesktopIcons);
	} else {
		initDesktopIcons();
	}

	// Swup 页面切换后重新初始化
	document.addEventListener("swup:contentReplaced", initDesktopIcons);
</script>
