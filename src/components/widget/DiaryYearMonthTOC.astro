---
/**
 * 日记年月目录组件
 * 显示日记的年份和月份导航
 */

interface Props {
	groupedMoments: any[];
}

const { groupedMoments } = Astro.props;
---

<div class="diary-toc-container">
	<nav class="diary-toc group">
		{groupedMoments.map(([year, months]) => {
			const totalCount = months.reduce((acc, [, arr]) => acc + arr.length, 0);
			return (
				<div class="toc-year-group mb-2" data-year={year}>
					<div class="toc-year-block">
						<a 
							href={`#year-${year}`}
							class="toc-year-link px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2"
						>
							<div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">
								{year.toString().slice(-2)}
							</div>
							<div class="transition text-sm text-90 flex-1">{year}</div>
							<span class="text-xs text-50">({totalCount})</span>
						</a>
						<div class="toc-months space-y-1">
							{months.map(([month, items]) => (
								<a
									href={`#month-${year}-${month}`}
									class="toc-month-link px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2"
								>
									<div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ml-4">
										<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>
									</div>
									<div class="transition text-sm text-75 flex-1">{month}月</div>
									<span class="text-xs text-50">({items.length})</span>
								</a>
							))}
						</div>
					</div>
				</div>
			);
		})}
		<div id="diary-active-indicator" class="-z-10 absolute bg-[var(--toc-btn-hover)] left-0 right-0 rounded-xl transition-all group-hover:bg-transparent border-2 border-[var(--toc-btn-hover)] group-hover:border-[var(--toc-btn-active)] border-dashed" style="display: none;"></div>
	</nav>
</div>

<style>
	.diary-toc-container {
		/* 移除之前的样式，使用TOC的样式体系 */
	}

	.diary-toc {
		position: relative;
	}

	/* 活动状态样式 */
	.toc-year-link.active,
	.toc-month-link.active {
		background-color: var(--toc-btn-hover);
	}

	/* 悬停阴影效果 - 包含年份与月份的整体块 */
	.toc-year-block {
		padding: 0.25rem 0.35rem;
		border-radius: 0.9rem;
		transition: background-color 0.2s ease, box-shadow 0.2s ease;
	}

	.toc-year-block:hover,
	.toc-year-block:has(.toc-month-link:hover),
	.toc-year-block:has(.toc-year-link:hover) {
		background-color: var(--toc-btn-hover);
		box-shadow: 0 4px 12px rgb(0 0 0 / 0.12), 0 2px 6px rgb(0 0 0 / 0.08);
	}

	/* 链接本身不额外叠加阴影，阴影由父块提供 */
	.toc-year-link:hover,
	.toc-month-link:hover {
		box-shadow: none;
	}
</style>

<script>
	// 监听滚动，高亮当前可见的年月
	function initDiaryTOC() {
		const yearGroups = document.querySelectorAll('.moment-group');
		const monthGroups = document.querySelectorAll('.moment-subgroup');
		const tocYearLinks = document.querySelectorAll('.toc-year-link');
		const tocMonthLinks = document.querySelectorAll('.toc-month-link');
		const activeIndicator = document.getElementById('diary-active-indicator');

		if (!yearGroups.length || !tocYearLinks.length) return;

		function updateActiveTOC() {
			const scrollPosition = window.scrollY + 200;

			// 找到当前可见的月份
			let activeMonthId = '';
			let activeYearId = '';
			let activeLink: Element | null = null;

			monthGroups.forEach((group) => {
				const rect = group.getBoundingClientRect();
				const groupTop = rect.top + window.scrollY;
				
				if (groupTop <= scrollPosition + 200) {
					activeMonthId = group.id;
					// 从月份ID中提取年份
					const match = activeMonthId.match(/month-(\d+)-/);
					if (match) {
						activeYearId = `year-${match[1]}`;
					}
				}
			});

			// 移除所有活动状态
			tocYearLinks.forEach(link => link.classList.remove('active'));
			tocMonthLinks.forEach(link => link.classList.remove('active'));

			// 添加活动状态并更新指示器
			if (activeMonthId) {
				const activeMonthLink = document.querySelector(`.toc-month-link[href="#${activeMonthId}"]`);
				if (activeMonthLink) {
					activeMonthLink.classList.add('active');
					activeLink = activeMonthLink;
				}
			} else if (activeYearId) {
				const activeYearLink = document.querySelector(`.toc-year-link[href="#${activeYearId}"]`);
				if (activeYearLink) {
					activeYearLink.classList.add('active');
					activeLink = activeYearLink;
				}
			}

			// 更新活动指示器位置
			if (activeIndicator && activeLink) {
				const linkRect = activeLink.getBoundingClientRect();
				const containerRect = activeLink.closest('.diary-toc')?.getBoundingClientRect();
				if (containerRect) {
					const top = linkRect.top - containerRect.top;
					activeIndicator.style.top = `${top}px`;
					activeIndicator.style.height = `${linkRect.height}px`;
					activeIndicator.style.display = 'block';
				}
			} else if (activeIndicator) {
				activeIndicator.style.display = 'none';
			}
		}

		// 监听滚动事件
		let scrollTimeout: number;
		window.addEventListener('scroll', () => {
			if (scrollTimeout) {
				window.cancelAnimationFrame(scrollTimeout);
			}
			scrollTimeout = window.requestAnimationFrame(updateActiveTOC);
		});

		// 初始化
		updateActiveTOC();

		// 平滑滚动到目标
		tocYearLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const targetId = link.getAttribute('href')?.substring(1);
				const target = document.getElementById(targetId || '');
				if (target) {
					target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					// 展开对应的年份
					const details = target as HTMLDetailsElement;
					if (details && details.tagName === 'DETAILS') {
						details.open = true;
					}
				}
			});
		});

		tocMonthLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const targetId = link.getAttribute('href')?.substring(1);
				const target = document.getElementById(targetId || '');
				if (target) {
					target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					// 展开对应的月份和年份
					const details = target as HTMLDetailsElement;
					if (details && details.tagName === 'DETAILS') {
						details.open = true;
						// 也展开父级年份
						const parentYear = details.closest('.moment-group') as HTMLDetailsElement;
						if (parentYear && parentYear.tagName === 'DETAILS') {
							parentYear.open = true;
						}
					}
				}
			});
		});
	}

	// 页面加载完成后初始化
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initDiaryTOC);
	} else {
		initDiaryTOC();
	}

	// Swup页面切换时处理
	document.addEventListener('swup:content:replace', () => {
		// 等待DOM更新
		setTimeout(() => {
			const isDiaryPage = window.location.pathname.includes('/diary');
			const diaryTocWrapper = document.getElementById('diary-toc-wrapper');
			
			if (diaryTocWrapper) {
				if (isDiaryPage) {
					diaryTocWrapper.style.display = '';
					setTimeout(initDiaryTOC, 50);
				} else {
					diaryTocWrapper.style.display = 'none';
				}
			}
		}, 0);
	});

	// 页面初始化时检查
	const checkInitialPage = () => {
		const isDiaryPage = window.location.pathname.includes('/diary');
		const diaryTocWrapper = document.getElementById('diary-toc-wrapper');
		
		if (diaryTocWrapper && !isDiaryPage) {
			diaryTocWrapper.style.display = 'none';
		}
	};
	
	checkInitialPage();
</script>
