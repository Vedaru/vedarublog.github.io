---
/**
 * æ—¥è®°å¹´æœˆç›®å½•ç»„ä»¶
 * æ˜¾ç¤ºæ—¥è®°çš„å¹´ä»½å’Œæœˆä»½å¯¼èˆª
 */

interface Props {
	groupedMoments: any[];
}

const { groupedMoments } = Astro.props;

console.log("DiaryYearMonthTOC - Received data:", groupedMoments?.length, "years");
---

<div class="diary-toc-container" style="background: rgba(255,0,0,0.1); border: 2px solid red;">
	<h2 class="text-base font-bold mb-3 text-90 px-2">ğŸ“… æ—¥è®°ç›®å½•</h2>
	<nav class="diary-toc group">
		{groupedMoments.map(([year, months]) => {
			const totalCount = months.reduce((acc, [, arr]) => acc + arr.length, 0);
			return (
				<div class="toc-year-group mb-2">
					<a 
						href={`#year-${year}`}
						class="toc-year-link px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2"
					>
						<div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">
							{year.toString().slice(-2)}
						</div>
						<div class="transition text-sm text-90 flex-1">{year}</div>
						<span class="text-xs text-50">({totalCount})</span>
					</a>
					<div class="toc-months space-y-1">
						{months.map(([month, items]) => (
							<a
								href={`#month-${year}-${month}`}
								class="toc-month-link px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2"
							>
								<div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ml-4">
									<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>
								</div>
								<div class="transition text-sm text-75 flex-1">{month}æœˆ</div>
								<span class="text-xs text-50">({items.length})</span>
							</a>
						))}
					</div>
				</div>
			);
		})}
		<div id="diary-active-indicator" class="-z-10 absolute bg-[var(--toc-btn-hover)] left-0 right-0 rounded-xl transition-all group-hover:bg-transparent border-2 border-[var(--toc-btn-hover)] group-hover:border-[var(--toc-btn-active)] border-dashed" style="display: none;"></div>
	</nav>
</div>

<style>
	.diary-toc-container {
		/* ç§»é™¤ä¹‹å‰çš„æ ·å¼ï¼Œä½¿ç”¨TOCçš„æ ·å¼ä½“ç³» */
	}

	.diary-toc {
		position: relative;
	}

	/* æ´»åŠ¨çŠ¶æ€æ ·å¼ */
	.toc-year-link.active,
	.toc-month-link.active {
		background-color: var(--toc-btn-hover);
	}
</style>

<script>
	// ç›‘å¬æ»šåŠ¨ï¼Œé«˜äº®å½“å‰å¯è§çš„å¹´æœˆ
	function initDiaryTOC() {
		const yearGroups = document.querySelectorAll('.moment-group');
		const monthGroups = document.querySelectorAll('.moment-subgroup');
		const tocYearLinks = document.querySelectorAll('.toc-year-link');
		const tocMonthLinks = document.querySelectorAll('.toc-month-link');
		const activeIndicator = document.getElementById('diary-active-indicator');

		if (!yearGroups.length || !tocYearLinks.length) return;

		function updateActiveTOC() {
			const scrollPosition = window.scrollY + 200;

			// æ‰¾åˆ°å½“å‰å¯è§çš„æœˆä»½
			let activeMonthId = '';
			let activeYearId = '';
			let activeLink: Element | null = null;

			monthGroups.forEach((group) => {
				const rect = group.getBoundingClientRect();
				const groupTop = rect.top + window.scrollY;
				
				if (groupTop <= scrollPosition + 200) {
					activeMonthId = group.id;
					// ä»æœˆä»½IDä¸­æå–å¹´ä»½
					const match = activeMonthId.match(/month-(\d+)-/);
					if (match) {
						activeYearId = `year-${match[1]}`;
					}
				}
			});

			// ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
			tocYearLinks.forEach(link => link.classList.remove('active'));
			tocMonthLinks.forEach(link => link.classList.remove('active'));

			// æ·»åŠ æ´»åŠ¨çŠ¶æ€å¹¶æ›´æ–°æŒ‡ç¤ºå™¨
			if (activeMonthId) {
				const activeMonthLink = document.querySelector(`.toc-month-link[href="#${activeMonthId}"]`);
				if (activeMonthLink) {
					activeMonthLink.classList.add('active');
					activeLink = activeMonthLink;
				}
			} else if (activeYearId) {
				const activeYearLink = document.querySelector(`.toc-year-link[href="#${activeYearId}"]`);
				if (activeYearLink) {
					activeYearLink.classList.add('active');
					activeLink = activeYearLink;
				}
			}

			// æ›´æ–°æ´»åŠ¨æŒ‡ç¤ºå™¨ä½ç½®
			if (activeIndicator && activeLink) {
				const linkRect = activeLink.getBoundingClientRect();
				const containerRect = activeLink.closest('.diary-toc')?.getBoundingClientRect();
				if (containerRect) {
					const top = linkRect.top - containerRect.top;
					activeIndicator.style.top = `${top}px`;
					activeIndicator.style.height = `${linkRect.height}px`;
					activeIndicator.style.display = 'block';
				}
			} else if (activeIndicator) {
				activeIndicator.style.display = 'none';
			}
		}

		// ç›‘å¬æ»šåŠ¨äº‹ä»¶
		let scrollTimeout: number;
		window.addEventListener('scroll', () => {
			if (scrollTimeout) {
				window.cancelAnimationFrame(scrollTimeout);
			}
			scrollTimeout = window.requestAnimationFrame(updateActiveTOC);
		});

		// åˆå§‹åŒ–
		updateActiveTOC();

		// å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡
		tocYearLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const targetId = link.getAttribute('href')?.substring(1);
				const target = document.getElementById(targetId || '');
				if (target) {
					target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					// å±•å¼€å¯¹åº”çš„å¹´ä»½
					const details = target as HTMLDetailsElement;
					if (details && details.tagName === 'DETAILS') {
						details.open = true;
					}
				}
			});
		});

		tocMonthLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const targetId = link.getAttribute('href')?.substring(1);
				const target = document.getElementById(targetId || '');
				if (target) {
					target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					// å±•å¼€å¯¹åº”çš„æœˆä»½å’Œå¹´ä»½
					const details = target as HTMLDetailsElement;
					if (details && details.tagName === 'DETAILS') {
						details.open = true;
						// ä¹Ÿå±•å¼€çˆ¶çº§å¹´ä»½
						const parentYear = details.closest('.moment-group') as HTMLDetailsElement;
						if (parentYear && parentYear.tagName === 'DETAILS') {
							parentYear.open = true;
						}
					}
				}
			});
		});
	}

	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initDiaryTOC);
	} else {
		initDiaryTOC();
	}

	// Swupé¡µé¢åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–
	document.addEventListener('swup:content:replace', () => {
		setTimeout(initDiaryTOC, 100);
	});
</script>
