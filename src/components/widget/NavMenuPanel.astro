---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { LinkPreset, type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	links: NavBarLink[];
}

// 国际化标题映射
const navTitleMap: Record<string, string> = {
	Links: I18nKey.navLinks,
	My: I18nKey.navMy,
	About: I18nKey.navAbout,
	Others: I18nKey.navOthers,
	Anime: I18nKey.anime,
	Diary: I18nKey.diary,
	Gallery: I18nKey.albums,
	Devices: I18nKey.devices,
	Projects: I18nKey.projects,
	Skills: I18nKey.skills,
	Timeline: I18nKey.timeline,
	Friends: I18nKey.friends,
};

// 获取国际化的标题
const getLocalizedName = (name: string): string => {
	const keyValue = navTitleMap[name];
	if (keyValue) {
		return i18n(keyValue as I18nKey);
	}
	return name;
};

type ProcessedNavBarLink = Omit<NavBarLink, "children"> & {
	children?: ProcessedNavBarLink[];
};

// 处理links中的LinkPreset转换
const processedLinks: ProcessedNavBarLink[] = Astro.props.links.map(
	(link: NavBarLink): ProcessedNavBarLink => ({
		...link,
		children: link.children?.map(
			(child: NavBarLink | LinkPreset): ProcessedNavBarLink => {
				if (typeof child === "number") {
					return LinkPresets[child] as ProcessedNavBarLink;
				}
				return child as ProcessedNavBarLink;
			},
		),
	}),
);
---
<div id="nav-menu-panel" class:list={"float-panel float-panel-closed fixed transition-all right-4 px-2 py-2 max-h-[80vh] overflow-y-auto"}>
    {processedLinks.map((link) => (
        <div class="mobile-menu-item">
            {link.children && link.children.length > 0 ? (
                <!-- 有子菜单的项目 -->
                <div class="mobile-dropdown" data-mobile-dropdown>
                    <button 
                        class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-8 w-full text-left
                            hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition"
                        data-mobile-dropdown-trigger
                        aria-expanded="false"
                    >
                        <div class="flex items-center transition text-black/75 dark:text-white/75 font-bold group-hover:text-[var(--primary)] group-active:text-[var(--primary)]">
                            {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                            {getLocalizedName(link.name)}
                        </div>
                        <Icon name="material-symbols:keyboard-arrow-down-rounded"
                              class="transition text-[1.25rem] text-[var(--primary)] mobile-dropdown-arrow duration-200"
                        />
                    </button>
                    <div class="mobile-submenu" data-mobile-submenu>
                        {link.children.map((child) => (
                            <a href={child.external ? child.url : url(child.url)} 
                               class="group flex justify-between items-center py-2 pl-6 pr-1 rounded-lg gap-8
                                   hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition"
                               target={child.external ? "_blank" : null}
                               data-submenu-item
                            >
                                <div class="flex items-center transition text-black/60 dark:text-white/60 font-medium group-hover:text-[var(--primary)] group-active:text-[var(--primary)]">
                                    {child.icon && <Icon name={child.icon} class="text-[1.1rem] mr-2" />}
                                    {getLocalizedName(child.name)}
                                </div>
                                {child.external && <Icon name="fa6-solid:arrow-up-right-from-square"
                                      class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                                />}
                            </a>
                        ))}
                    </div>
                </div>
            ) : (
                <!-- 普通链接项目 -->
                <a href={link.external ? link.url : url(link.url)} class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-8
                    hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition
                "
                   target={link.external ? "_blank" : null}
                   data-nav-link
                >
                    <div class="flex items-center transition text-black/75 dark:text-white/75 font-bold group-hover:text-[var(--primary)] group-active:text-[var(--primary)]">
                        {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                        {getLocalizedName(link.name)}
                    </div>
                    {!link.external && <Icon name="material-symbols:chevron-right-rounded"
                          class="transition text-[1.25rem] text-[var(--primary)]"
                    />}
                    {link.external && <Icon name="fa6-solid:arrow-up-right-from-square"
                          class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                    />}
                </a>
            )}
        </div>
    ))}
</div>

<style>
    #nav-menu-panel {
        transform-origin: top right;
        will-change: transform, opacity;
    }
    
    #nav-menu-panel:not(.float-panel-closed) {
        animation: menuSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    #nav-menu-panel.float-panel-closed {
        animation: menuSlideOut 0.25s cubic-bezier(0.4, 0, 1, 1) forwards;
    }
    
    @keyframes menuSlideIn {
        from {
            transform: translateY(-12px) scale(0.95);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes menuSlideOut {
        from {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        to {
            transform: translateY(-12px) scale(0.95);
            opacity: 0;
        }
    }
    
    .mobile-submenu {
        @apply max-h-0 overflow-hidden transition-all duration-300 ease-in-out;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-submenu {
        @apply max-h-96;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-dropdown-arrow {
        @apply rotate-180;
    }
    
    /* 移除移动端点击高亮效果 */
    button, a {
        -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
        -webkit-touch-callout: none !important;
        tap-highlight-color: rgba(0,0,0,0) !important;
        outline: none !important;
    }
    
    button:focus, a:focus, button:active, a:active,
    button:focus-visible, a:focus-visible {
        outline: none !important;
        box-shadow: none !important;
        -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
    }
</style>

<script type="module" is:inline>
    // 防止重复初始化的标记
    if (window.__navMenuPanelInitialized) {
        console.debug('[NavMenuPanel] Already initialized, skipping');
    } else {
        window.__navMenuPanelInitialized = true;
        
        // 等待 panelManager 可用的辅助函数
        async function waitForPanelManager(maxWaitTime = 5000) {
            const startTime = Date.now();
            while (!window['panelManager']) {
                if (Date.now() - startTime > maxWaitTime) {
                    console.error('panelManager not available after waiting');
                    return null;
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            return window['panelManager'];
        }
        
        async function initNavMenuPanel() {
            const mobileDropdowns = document.querySelectorAll('[data-mobile-dropdown]');
            
            // 等待并使用全局 panelManager
            try {
                const panelManager = await waitForPanelManager();
                if (!panelManager) {
                    console.warn('panelManager not initialized');
                    return;
                }
                
                // 检查 closePanel 方法是否存在
                if (typeof panelManager.closePanel !== 'function') {
                    console.error('panelManager.closePanel is not a function');
                    return;
                }
                
                // 使用事件委托而不是为每个元素添加监听器
                document.addEventListener('click', async function(e) {
                    const submenuItem = e.target.closest('[data-submenu-item]');
                    const navLink = e.target.closest('[data-nav-link]');
                    
                    if (submenuItem || navLink) {
                        console.log('Nav link clicked, closing nav-menu-panel');
                        try {
                            await panelManager.closePanel('nav-menu-panel');
                        } catch (error) {
                            console.error('Error closing panel:', error);
                        }
                    }
                }, { capture: true, once: false });
                
            } catch (error) {
                console.error('Failed to initialize panelManager:', error);
            }
            
            mobileDropdowns.forEach(dropdown => {
                const trigger = dropdown.querySelector('[data-mobile-dropdown-trigger]');
                const submenu = dropdown.querySelector('[data-mobile-submenu]');
                
                if (!trigger || !submenu) return;

            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Dropdown trigger clicked:', trigger);
                
                const isExpanded = dropdown.getAttribute('data-expanded') === 'true';
                console.log('Current expanded state:', isExpanded);
                
                // 关闭其他打开的下拉菜单
                mobileDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        otherDropdown.setAttribute('data-expanded', 'false');
                        const otherTrigger = otherDropdown.querySelector('[data-mobile-dropdown-trigger]');
                        if (otherTrigger) {
                            otherTrigger.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                // 切换当前下拉菜单
                const newState = !isExpanded;
                console.log('Setting expanded state to:', newState);
                dropdown.setAttribute('data-expanded', newState.toString());
                trigger.setAttribute('aria-expanded', newState.toString());
                });
                
                // 阻止子菜单点击时冒泡
                submenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNavMenuPanel);
        } else {
            initNavMenuPanel();
        }
    }
</script>
