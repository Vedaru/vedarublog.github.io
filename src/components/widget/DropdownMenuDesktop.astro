---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { LinkPreset, type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	link: NavBarLink;
	class?: string;
}

const { link, class: className } = Astro.props;

// 国际化标题映射
const navTitleMap: Record<string, string> = {
	Links: I18nKey.navLinks,
	My: I18nKey.navMy,
	About: I18nKey.navAbout,
	Others: I18nKey.navOthers,
	Anime: I18nKey.anime,
	Diary: I18nKey.diary,
	Gallery: I18nKey.albums,
	Devices: I18nKey.devices,
	Projects: I18nKey.projects,
	Skills: I18nKey.skills,
	Timeline: I18nKey.timeline,
	Friends: I18nKey.friends,
	Archive: I18nKey.archive,
};

// 获取国际化的标题
const getLocalizedName = (name: string): string => {
	const keyValue = navTitleMap[name];
	if (keyValue) {
		return i18n(keyValue as I18nKey);
	}
	return name;
};

// 转换子菜单中的LinkPreset为NavBarLink
const processedLink = {
	...link,
	children: link.children?.map((child: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof child === "number") {
			return LinkPresets[child];
		}
		return child;
	}),
};

const hasChildren = processedLink.children && processedLink.children.length > 0;

// 定义哪些页面应该在窗口中打开 - 现在默认所有内部链接都以窗口方式打开
function shouldOpenInWindow(urlPath: string): boolean {
	// 排除外部链接，所有内部链接都以窗口方式打开
	return true;
}

function getWindowId(urlPath: string): string {
	// 从 URL 路径提取页面标识
	const match = urlPath.match(/\/([^\/]+)\/?$/);
	if (match && match[1]) {
		return match[1];
	}
	// 如果是根路径，返回 'home'
	if (urlPath === '/' || urlPath === '') {
		return 'home';
	}
	return 'default';
}
---

<div class:list={["dropdown-container", className]} data-dropdown>
	{hasChildren ? (
		<button 
			class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 dropdown-trigger"
			aria-expanded="false"
			aria-haspopup="true"
			data-dropdown-trigger
		>
			<div class="flex items-center">
				{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2" />}
				{getLocalizedName(processedLink.name)}
				<Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-[1.25rem] transition-transform duration-200 dropdown-arrow ml-1" />
			</div>
		</button>
		<div class="dropdown-menu" data-dropdown-menu>
			<div class="dropdown-content">
				{processedLink.children?.map((child) => {
					const childUrl = child.external ? child.url : url(child.url);
					const openInWindow = !child.external && shouldOpenInWindow(child.url);
					
					return openInWindow ? (
						<button 
							class="dropdown-item window-link"
							data-window-id={getWindowId(child.url)}
							data-window-title={getLocalizedName(child.name)}
							data-window-url={childUrl}
							aria-label={child.name}
						>
							<div class="flex items-center">
								{child.icon && <Icon name={child.icon} class="text-[1rem] mr-2" />}
								<span>{getLocalizedName(child.name)}</span>
							</div>
						</button>
					) : (
						<a 
							href={childUrl} 
							target={child.external ? "_blank" : null}
							class="dropdown-item"
							aria-label={child.name}
						>
							<div class="flex items-center">
								{child.icon && <Icon name={child.icon} class="text-[1rem] mr-2" />}
								<span>{getLocalizedName(child.name)}</span>
							</div>
							{child.external && (
								<Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.75rem] text-black/25 dark:text-white/25" />
							)}
						</a>
					);
				})}
			</div>
		</div>
	) : (
		shouldOpenInWindow(processedLink.url) ? (
			<button 
				class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 window-link"
				data-window-id={getWindowId(processedLink.url)}
				data-window-title={getLocalizedName(processedLink.name)}
				data-window-url={url(processedLink.url)}
				aria-label={processedLink.name}
			>
				<div class="flex items-center">
					{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2" />}
					{getLocalizedName(processedLink.name)}
				</div>
			</button>
		) : (
			<a 
				aria-label={processedLink.name} 
				href={processedLink.external ? processedLink.url : url(processedLink.url)} 
				target={processedLink.external ? "_blank" : null}
				class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95"
			>
				<div class="flex items-center">
					{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2" />}
					{getLocalizedName(processedLink.name)}
					{processedLink.external && <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]" />}
				</div>
			</a>
		)
	)}
</div>

<style>
	.dropdown-container {
		@apply relative;
	}

	.dropdown-menu {
		@apply absolute top-full left-0 pt-2 opacity-0 invisible pointer-events-none transition-all duration-200 ease-out transform translate-y-[-8px] z-50;
	}

	.dropdown-container:hover .dropdown-menu,
	.dropdown-container:focus-within .dropdown-menu {
		@apply opacity-100 visible pointer-events-auto translate-y-0;
	}

	.dropdown-container:hover .dropdown-arrow,
	.dropdown-container:focus-within .dropdown-arrow {
		@apply rotate-180;
	}

	.dropdown-content {
		@apply bg-[var(--float-panel-bg)] rounded-[var(--radius-large)] shadow-xl dark:shadow-none border border-black/5 dark:border-white/10 py-2 min-w-[12rem];
	}

	.dropdown-item {
		@apply flex items-center justify-between px-4 py-2.5 text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition-colors duration-150 font-medium w-full text-left;
	}

	button.dropdown-item {
		@apply border-none bg-transparent cursor-pointer;
	}

	.dropdown-item:first-child {
		@apply rounded-t-[calc(var(--radius-large)-0.5rem)];
	}

	.dropdown-item:last-child {
		@apply rounded-b-[calc(var(--radius-large)-0.5rem)];
	}

	/* 移动端隐藏下拉菜单 */
	@media (max-width: 768px) {
		.dropdown-container {
			@apply hidden;
		}
	}
</style>

<script>
	import { openDesktopWindow } from '../../utils/desktop-utils';
	
	// 处理窗口链接点击
	document.addEventListener('click', function(e) {
		const target = e.target as HTMLElement;
		const windowLink = target.closest('.window-link') as HTMLElement;
		
		if (windowLink) {
			e.preventDefault();
			const windowId = windowLink.dataset.windowId || 'default';
			const windowTitle = windowLink.dataset.windowTitle || 'Window';
			const windowUrl = windowLink.dataset.windowUrl || '';
			
			openDesktopWindow({
				id: windowId,
				title: windowTitle,
				component: windowId,
				width: 900,
				height: 650
			});
		}
	});
	
	// 键盘导航支持
	document.addEventListener('DOMContentLoaded', function() {
		const dropdowns = document.querySelectorAll('[data-dropdown]');
		
		dropdowns.forEach(dropdown => {
			const trigger = dropdown.querySelector('[data-dropdown-trigger]');
			const menu = dropdown.querySelector('[data-dropdown-menu]');
			
			if (!trigger || !menu) return;
			
			trigger.addEventListener('keydown', (e: Event) => {
				const event = e as KeyboardEvent;
				if (event.key === 'Enter' || event.key === ' ') {
					event.preventDefault();
					const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
					trigger.setAttribute('aria-expanded', String(!isExpanded));
				}
			});
		});
	});
</script>
