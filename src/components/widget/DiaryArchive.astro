---
/**
 * 日记归档组件 - 用于侧边栏显示
 * 显示日记的年份和月份归档
 */

import { getDiaryList } from "../../data/diary";

// 获取日记数据
const moments = getDiaryList(Number.MAX_SAFE_INTEGER);

// 按年 -> 月分组
const groupByYearMonth = (list: any[]) => {
	const yearMap = new Map();
	list.forEach((m: any) => {
		const datePart = m.date.split('T')[0];
		const [yStr, mStr] = datePart.split('-');
		const y = parseInt(yStr, 10);
		const mth = String(parseInt(mStr, 10)).padStart(2, "0");
		if (!yearMap.has(y)) yearMap.set(y, new Map());
		const monthMap = yearMap.get(y);
		if (!monthMap.has(mth)) monthMap.set(mth, []);
		monthMap.get(mth).push(m);
	});
	return Array.from(yearMap.entries())
		.sort((a: any, b: any) => (a[0] < b[0] ? 1 : -1))
		.map(([year, mMap]: any) => [
			year,
			Array.from(mMap.entries()).sort((a: any, b: any) => (a[0] < b[0] ? 1 : -1)),
		]);
};

const groupedMoments = groupByYearMonth(moments);

interface Props {
	class?: string;
}

const { class: className } = Astro.props;
---

<div class:list={["card-base overflow-hidden", className]}>
	<div
		class="flex flex-row items-center justify-between relative w-full h-[3.75rem] px-6 transition"
	>
		<div class="flex items-center gap-3">
			<div
				class="transition flex items-center justify-center font-bold text-[var(--primary)] dark:text-[var(--primary)]"
			>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
					<line x1="16" x2="16" y1="2" y2="6"></line>
					<line x1="8" x2="8" y1="2" y2="6"></line>
					<line x1="3" x2="21" y1="10" y2="10"></line>
				</svg>
			</div>
			<div class="flex flex-col">
				<div class="text-sm font-bold text-75">日记归档</div>
			</div>
		</div>
	</div>

	<div class="px-4 pb-4 max-h-[400px] overflow-y-auto diary-archive-scroll">
		{groupedMoments.map(([year, months]) => {
			const totalCount = months.reduce((acc, [, arr]) => acc + arr.length, 0);
			return (
				<div class="mb-3">
					<a 
						href={`/diary/#year-${year}`}
						class="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-[var(--btn-plain-bg-hover)] transition-all text-90 font-semibold text-sm group"
					>
						<span class="group-hover:text-[var(--primary)] transition">{year}</span>
						<span class="text-xs text-50 group-hover:text-[var(--primary)] transition">({totalCount})</span>
					</a>
					<div class="ml-4 mt-1 space-y-1">
						{months.map(([month, items]) => (
							<a
								href={`/diary/#month-${year}-${month}`}
								class="flex items-center justify-between py-1.5 px-3 rounded-md hover:bg-[var(--btn-plain-bg-hover)] transition-all text-75 text-xs group"
							>
								<span class="group-hover:text-[var(--primary)] transition">{month}月</span>
								<span class="text-xs text-50 group-hover:text-[var(--primary)] transition">({items.length})</span>
							</a>
						))}
					</div>
				</div>
			);
		})}
	</div>
</div>

<style>
	.card-base {
		background: var(--card-bg);
		border-radius: var(--radius-large);
		transition: all 0.3s ease;
	}

	/* 美化滚动条 */
	.diary-archive-scroll {
		scrollbar-width: thin;
		scrollbar-color: var(--primary) transparent;
	}

	.diary-archive-scroll::-webkit-scrollbar {
		width: 4px;
	}

	.diary-archive-scroll::-webkit-scrollbar-thumb {
		background-color: var(--primary);
		border-radius: 2px;
	}

	.diary-archive-scroll::-webkit-scrollbar-track {
		background: transparent;
	}
</style>
