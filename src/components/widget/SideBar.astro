---
import type { MarkdownHeading } from "astro";
import type { WidgetComponentConfig } from "../../types/config";
import { widgetManager } from "../../utils/widget-manager";
import Announcement from "./Announcement.astro";
import Calendar from "./Calendar.astro";
import Categories from "./Categories.astro";
import Profile from "./Profile.astro";
import SiteStats from "./SiteStats.astro";
import Tags from "./Tags.astro";
import TOC from "./TOC.astro";

// 异步加载音乐播放器组件
const MusicPlayer = (await import("./MusicPlayer.svelte")).default;

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
	isBothSidebarMode?: boolean;
}

const { class: className, headings } = Astro.props;

// 获取配置的组件列表
// 在双侧边栏模式下，桌面端只获取左侧组件
// 手机端仍然获取所有组件（不指定sidebar参数）以保持原有布局
const isBothSidebarMode = Astro.props.isBothSidebarMode ?? false;
const topComponents = isBothSidebarMode
	? widgetManager.getComponentsByPosition("top", "left")
	: widgetManager.getComponentsByPosition("top");
const stickyComponents = isBothSidebarMode
	? widgetManager.getComponentsByPosition("sticky", "left")
	: widgetManager.getComponentsByPosition("sticky");

// 组件映射表
const componentMap = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	toc: TOC,
	"music-player": MusicPlayer,
	"site-stats": SiteStats,
	calendar: Calendar,
};

// 渲染组件的辅助函数
function renderComponent(
	component: WidgetComponentConfig,
	index: number,
	_components: WidgetComponentConfig[],
) {
	const ComponentToRender =
		componentMap[component.type as keyof typeof componentMap];
	if (!ComponentToRender) return null;

	const componentClass = widgetManager.getComponentClass(component, index);
	const componentStyle = widgetManager.getComponentStyle(component, index);

	return {
		Component: ComponentToRender,
		props: {
			class: componentClass,
			style: componentStyle,
			headings: component.type === "toc" ? headings : undefined,
			...component.customProps,
		},
	};
}

// 将必要的响应式配置序列化到客户端脚本中，避免在浏览器端直接导入 server-only 模块
const breakpoints = widgetManager.getBreakpoints();
const clientResponsiveLayout = widgetManager.getConfig().responsive.layout;
---

<div id="sidebar" class:list={[className, "w-full"]}>
	<!-- 顶部固定组件区域 -->
	{topComponents.length > 0 && (
		<div class="flex flex-col w-full gap-4 mb-4">
			{topComponents.map((component, index) => {
				const renderData = renderComponent(component, index, topComponents);
				if (!renderData) return null;
				
				const { Component, props } = renderData;
				return <Component {...props} />;
			})}
		</div>
	)}
	
	<!-- 粘性组件区域 -->
	{stickyComponents.length > 0 && (
		<div id="sidebar-sticky" class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4">
			{stickyComponents.map((component, index) => {
				const renderData = renderComponent(component, index, stickyComponents);
				if (!renderData) return null;
				
				const { Component, props } = renderData;
				return <Component {...props} />;
			})}
		</div>
	)}
</div>

<!-- 响应式样式和JavaScript -->
<style>
	/* 响应式断点样式 */
	@media (max-width: 1280px) {
		#sidebar {
			display: var(--sidebar-mobile-display, block);
		}
	}
	
	@media (min-width: 769px) and (max-width: 1279px) {
		#sidebar {
			display: var(--sidebar-tablet-display, block);
		}
	}

	@media (min-width: 1280px) {
		#sidebar {
			display: var(--sidebar-desktop-display, block);
		}
	}
</style>

<script type="module" is:inline>
	// 服务端序列化的断点和响应式布局（由 widgetManager 提供）
	const BREAKPOINTS = {JSON.stringify(breakpoints)};
	const RESPONSIVE_LAYOUT = {JSON.stringify(clientResponsiveLayout)};

	// 响应式布局管理（客户端）
	class SidebarManager {
		constructor() {
			this.init();
		}

		init() {
			this.updateResponsiveDisplay();
			window.addEventListener('resize', () => this.updateResponsiveDisplay());

			if (typeof window !== 'undefined' && window.swup) {
				window.swup.hooks.on('content:replace', () => {
					setTimeout(() => this.updateResponsiveDisplay(), 100);
				});
			}
		}

		updateResponsiveDisplay() {
			const width = window.innerWidth;

			let deviceType;
			if (width < BREAKPOINTS.mobile) {
				deviceType = 'mobile';
			} else if (width < BREAKPOINTS.tablet) {
				deviceType = 'tablet';
			} else {
				deviceType = 'desktop';
			}

			const shouldShow = RESPONSIVE_LAYOUT[deviceType] === 'sidebar';
			const sidebar = document.getElementById('sidebar');
			if (sidebar) {
				sidebar.style.setProperty(
					`--sidebar-${deviceType}-display`,
					shouldShow ? 'block' : 'none'
				);
			}
		}
	}

	new SidebarManager();
</script>
