---
import { siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { getSortedPosts } from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 获取所有文章
const posts = await getSortedPosts();

// 创建文章日期映射（格式：YYYY-MM-DD -> 文章列表）
const postDateMap = new Map<string, { id: string; title: string; published: string }[]>();
posts.forEach((post) => {
  const date = new Date(post.data.published);
    const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}`;
  const existingPosts = postDateMap.get(dateKey) || [];
  postDateMap.set(dateKey, [...existingPosts, {
    id: post.id,
    title: post.data.title,
    published: date.toISOString()
  }]);
});

// 序列化所有文章数据供客户端使用
const allPostsData = posts.map((post) => ({
  id: post.id,
  title: post.data.title,
    published: new Date(post.data.published).toISOString(),
}));

// 月份名称（使用 i18n）
const monthNames = [
	i18n(I18nKey.calendarJanuary),
	i18n(I18nKey.calendarFebruary),
	i18n(I18nKey.calendarMarch),
	i18n(I18nKey.calendarApril),
	i18n(I18nKey.calendarMay),
	i18n(I18nKey.calendarJune),
	i18n(I18nKey.calendarJuly),
	i18n(I18nKey.calendarAugust),
	i18n(I18nKey.calendarSeptember),
	i18n(I18nKey.calendarOctober),
	i18n(I18nKey.calendarNovember),
	i18n(I18nKey.calendarDecember),
];

// 星期名称（简写，使用 i18n）
const weekDays = [
	i18n(I18nKey.calendarSunday),
	i18n(I18nKey.calendarMonday),
	i18n(I18nKey.calendarTuesday),
	i18n(I18nKey.calendarWednesday),
	i18n(I18nKey.calendarThursday),
	i18n(I18nKey.calendarFriday),
	i18n(I18nKey.calendarSaturday),
];

// 判断是否为中文环境
const isChinese = siteConfig.lang.startsWith("zh");
const yearSuffix = isChinese ? "年" : " ";
---

<WidgetLayout id="calendar-widget" class={"hidden md:block " + (className || "") } style={style}>
  <div id="calendar-widget" class="collapse-wrapper px-4 overflow-hidden" data-astro-cid-ucso7hve="" style="">
    <div class="flex justify-between items-center mb-2 mt-2">
      <div class="font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-4 flex items-center
          before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
          before:absolute before:left-[-16px] before:top-[13.5px]">
        <div id="calendar-title-container" class="flex justify-center items-center cursor-pointer hover:bg-[var(--btn-plain-bg-hover)] px-2 py-2 -ml-2 rounded-lg transition-colors">
          <span id="calendar-title" class="text-lg font-bold text-neutral-900 dark:text-neutral-100 select-none">{new Date().getFullYear()}  {monthNames[new Date().getMonth()]}</span>
        </div>
      </div>
      <div class="flex items-center gap-1 shrink-0 ml-2">
        <button id="back-to-today-btn" class="p-1.5 rounded-md hover:bg-[var(--btn-plain-bg-hover)] text-[var(--primary)] transition-all" aria-label="Back to today">
          <svg width="1em" height="1em" class="text-xl" data-icon="material-symbols:restart-alt-rounded">
            <symbol id="ai:material-symbols:restart-alt-rounded" viewBox="0 0 24 24"><path fill="currentColor" d="M9.825 20.7q-2.575-.725-4.2-2.837T4 13q0-1.425.475-2.713t1.35-2.362q.275-.3.675-.313t.725.313q.275.275.288.675t-.263.75q-.6.775-.925 1.7T6 13q0 2.025 1.188 3.613t3.062 2.162q.325.1.538.375t.212.6q0 .5-.35.788t-.825.162m4.35 0q-.475.125-.825-.175t-.35-.8q0-.3.213-.575t.537-.375q1.875-.6 3.063-2.175T18 13q0-2.5-1.75-4.25T12 7h-.075l.4.4q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-2.1-2.1q-.15-.15-.212-.325T8.55 6t.063-.375t.212-.325l2.1-2.1q.275-.275.7-.275t.7.275t.275.7t-.275.7l-.4.4H12q3.35 0 5.675 2.325T20 13q0 2.725-1.625 4.85t-4.2 2.85"></path></symbol>
            <use href="#ai:material-symbols:restart-alt-rounded"></use>
          </svg>
        </button>
        <button id="prev-month-btn" class="p-1.5 rounded-md hover:bg-[var(--btn-plain-bg-hover)] text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors text-xl font-extrabold" aria-label="Previous month" style="visibility: visible;">＜</button>
        <button id="next-month-btn" class="p-1.5 rounded-md hover:bg-[var(--btn-plain-bg-hover)] text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors text-xl font-extrabold" aria-label="Next month" style="visibility: visible;">＞</button>
      </div>
    </div>

    <div class="relative w-full overflow-hidden" style="min-height: 250px;">
      <div id="calendar-view" class="w-full opacity-100">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Mon </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Tue </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Wed </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Thu </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Fri </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Sat </div>
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1"> Sun </div>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>

        <div id="calendar-posts" class="mt-4">
          <div class="h-[1px] w-full bg-neutral-200 dark:bg-neutral-700 mb-2 hidden" id="calendar-posts-divider"></div>
          <div class="flex flex-col gap-1 max-h-[150px] overflow-y-auto custom-scrollbar" id="calendar-posts-list"></div>
        </div>
      </div>

      <div id="selection-panel" class="absolute inset-0 bg-[var(--card-bg)] z-10 flex flex-col transition-opacity duration-200 opacity-0 hidden">
        <div id="selection-content" class="w-full h-full p-2 grid grid-cols-4 gap-2 content-start overflow-y-auto">
          <!-- 年份项将由客户端填充（保留默认若无） -->
        </div>
      </div>
    </div>
  </div>
</WidgetLayout>

<script is:inline define:vars={{ postDateMap: Object.fromEntries(postDateMap), allPostsData, monthNames, weekDays, yearSuffix }}>
  // 客户端动态渲染日历
  function renderCalendar() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDate = now.getDate();
    
    // 更新 Widget 标题（优先使用新的 `calendar-title`）
    const titleElement = document.getElementById('calendar-title') || document.getElementById('calendar-widget-title');
    if (titleElement) {
      titleElement.textContent = `${currentYear}${yearSuffix}${monthNames[currentMonth]}`;
    }
    
    // 获取月份的第一天是星期几
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    
    // 获取当月天数
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    // 生成日历格子
    const calendarGrid = document.getElementById('calendar-grid');
    if (!calendarGrid) return;
    
    const calendarDays = [];
    
    // 添加空白格子（月初空白）
    for (let i = 0; i < firstDayOfMonth; i++) {
      calendarDays.push({ day: null, hasPost: false, count: 0, dateKey: "" });
    }
    
    // 添加每一天
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const posts = postDateMap[dateKey] || [];
      const count = posts.length;
      calendarDays.push({
        day,
        hasPost: count > 0,
        count,
        dateKey
      });
    }
    
    // 渲染日历格子
    calendarGrid.innerHTML = calendarDays.map(({day, hasPost, count, dateKey}) => {
      const isToday = day === currentDate;
      const classes = [
        "calendar-day aspect-square flex items-center justify-center rounded text-sm relative cursor-pointer"
      ];
      
      if (!day) {
        classes.push("text-neutral-400 dark:text-neutral-600");
      } else if (!hasPost) {
        classes.push("text-neutral-700 dark:text-neutral-300");
      } else {
        classes.push("text-neutral-900 dark:text-neutral-100 font-bold");
      }
      
      if (isToday) {
        classes.push("ring-2 ring-[var(--primary)]");
      }
      
      return `
        <div
          class="${classes.join(' ')}"
          data-date="${dateKey}"
          data-has-post="${hasPost}"
        >
          ${day || ''}
          ${hasPost ? '<span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-[var(--primary)]"></span>' : ''}
          ${hasPost && count > 1 ? `<span class="absolute top-0 right-0 text-[10px] text-[var(--primary)] font-bold">${count}</span>` : ''}
        </div>
      `;
    }).join('');
    
    // 获取当月所有文章
    const currentMonthPosts = allPostsData.filter(post => {
      const date = new Date(post.published);
      return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
    });
    
    // 显示当月文章列表
    showMonthlyPosts(currentMonthPosts);
    
    // 添加点击事件监听
    setupClickHandlers(currentMonthPosts);
  }
  
  // 显示当月所有文章
  function showMonthlyPosts(currentMonthPosts) {
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    
    if (postsList) {
      postsList.innerHTML = currentMonthPosts.map(post => `
        <a href="/posts/${post.id}/" class="block text-sm text-neutral-700 dark:text-neutral-300 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors truncate px-2 py-1 rounded hover:bg-[var(--btn-plain-bg-hover)]">
          ${post.title}
        </a>
      `).join('');
      
      // 显示/隐藏分割线
      if (divider) {
        divider.style.display = currentMonthPosts.length > 0 ? 'block' : 'none';
      }
    }
  }
  
  // 设置日历格子点击事件
  function setupClickHandlers(currentMonthPosts) {
    const calendarDays = document.querySelectorAll('.calendar-day[data-date]');
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    
    let currentSelectedDay = null;
    
    calendarDays.forEach(dayElement => {
      dayElement.addEventListener('click', () => {
        const dateKey = dayElement.getAttribute('data-date');
        const hasPost = dayElement.getAttribute('data-has-post') === 'true';
        
        if (!hasPost || !dateKey) return;
        
        // 切换选中状态
        if (currentSelectedDay === dayElement) {
          // 取消选中，恢复显示当月所有文章
          dayElement.classList.remove('bg-[var(--primary)]', 'bg-opacity-10');
          currentSelectedDay = null;
          showMonthlyPosts(currentMonthPosts);
          return;
        }
        
        // 移除之前选中的样式
        if (currentSelectedDay) {
          currentSelectedDay.classList.remove('bg-[var(--primary)]', 'bg-opacity-10');
        }
        
        // 添加选中样式
        dayElement.classList.add('bg-[var(--primary)]', 'bg-opacity-10');
        currentSelectedDay = dayElement;
        
        // 获取该日期的文章
        const posts = postDateMap[dateKey] || [];
        
        if (posts.length > 0 && postsList) {
          // 渲染文章列表
          postsList.innerHTML = posts.map(post => `
            <a href="/posts/${post.id}/" class="block text-sm text-neutral-700 dark:text-neutral-300 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors truncate px-2 py-1 rounded hover:bg-[var(--btn-plain-bg-hover)]">
              ${post.title}
            </a>
          `).join('');
          
          // 显示分割线
          if (divider) {
            divider.style.display = 'block';
          }
        }
      });
    });
  }
  
  // 页面加载时渲染日历
  renderCalendar();
  
  // 每天午夜更新一次日历（可选）
  const now = new Date();
  const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
  const msUntilMidnight = tomorrow.getTime() - now.getTime();
  
  setTimeout(() => {
    renderCalendar();
    // 之后每24小时更新一次
    setInterval(renderCalendar, 24 * 60 * 60 * 1000);
  }, msUntilMidnight);
</script>

<style>
  .calendar-day {
    transition: all 0.2s ease;
    min-height: 32px;
  }
  
  .calendar-day[data-has-post="true"]:hover {
    transform: translateY(-2px);
  }
</style>
