---
import { Icon } from "astro-icon/components";
import { announcementConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";

const config = announcementConfig;

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<!-- 组件显示现在由sidebarLayoutConfig统一控制，无需检查config.enable -->
<WidgetLayout 
    name={config.title || i18n(I18nKey.announcement)} 
    id="announcement"
    class={className} 
    style={style}
>
    <div>
        <!-- 公告栏内容 -->
        <div class="text-neutral-600 dark:text-neutral-300 leading-relaxed mb-3">
            {config.content}
        </div>
        
        <!-- 可选链接和关闭按钮 -->
        <div class="flex items-center justify-between gap-3">
            <div>
                {config.link && config.link.enable !== false && (
                    <a 
                        href={config.link.url} 
                        target={config.link.external ? "_blank" : "_self"}
                        rel={config.link.external ? "noopener noreferrer" : undefined}
                        class="btn-regular rounded-lg px-3 py-1.5 text-sm font-medium active:scale-95 transition-transform"
                    >
                        {config.link.text}

                    </a>
                )}
            </div>
            
            {config.closable && (
                <button 
                    class="btn-regular rounded-lg h-8 w-8 text-sm hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                    onclick="closeAnnouncement()"
                    aria-label={i18n(I18nKey.announcementClose)}
                >
                    <Icon name="fa6-solid:xmark" class="text-sm" />
                </button>
            )}
        </div>
    </div>
</WidgetLayout>

<script define:vars={{ persistClose: config.persistClose ?? false }}>
    function closeAnnouncement() {
        // 通过data-id属性找到整个widget-layout元素
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout) {
            // 隐藏整个widget-layout元素
            widgetLayout.style.display = 'none';
            
            // 根据配置决定是否持久化保存关闭状态
            if (persistClose) {
                // 持久化保存到localStorage（刷新页面后仍然关闭）
                localStorage.setItem('announcementClosed', 'true');
            } else {
                // 仅在当前会话中保存到sessionStorage（刷新页面后恢复显示）
                sessionStorage.setItem('announcementClosed', 'true');
            }
            
            // 更新导航栏按钮的可见性
            updateAnnouncementButtonVisibility();
        }
    }

    function showAnnouncement() {
        // 显示公告
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout) {
            widgetLayout.style.display = 'block';
            // 清除关闭状态
            sessionStorage.removeItem('announcementClosed');
            localStorage.removeItem('announcementClosed');
            // 更新按钮可见性
            updateAnnouncementButtonVisibility();
        }
    }

    function updateAnnouncementButtonVisibility() {
        const button = document.getElementById('announcement-show-switch');
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (button && widgetLayout) {
            // 如果公告被隐藏，显示按钮；否则隐藏按钮
            const isAnnouncementHidden = widgetLayout.style.display === 'none';
            if (isAnnouncementHidden) {
                button.classList.remove('hidden');
            } else {
                button.classList.add('hidden');
            }
        }
    }

    // 页面加载时恢复公告显示状态
    document.addEventListener('DOMContentLoaded', function() {
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout) {
            // 检查是否被关闭
            const isClosed = sessionStorage.getItem('announcementClosed') === 'true' || localStorage.getItem('announcementClosed') === 'true';
            // 设置正确的显示状态
            widgetLayout.style.display = isClosed ? 'none' : 'block';
            // 初始化按钮可见性
            updateAnnouncementButtonVisibility();
        }
    });

    // 支持Swup页面切换时恢复公告显示
    document.addEventListener('swup:page:view', function() {
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout) {
            // 检查是否被关闭
            const isClosed = sessionStorage.getItem('announcementClosed') === 'true' || localStorage.getItem('announcementClosed') === 'true';
            // 设置正确的显示状态
            widgetLayout.style.display = isClosed ? 'none' : 'block';
            // 更新按钮可见性
            updateAnnouncementButtonVisibility();
        }
    });

    // 使公告栏函数全局可用
    window.closeAnnouncement = closeAnnouncement;
    window.showAnnouncement = showAnnouncement;
</script>