---
import { commentConfig } from "@/config";

interface Props {
	path: string;
}

const config = {
	...commentConfig.twikoo,
	el: "#tcomment",
	path: Astro.props.path,
};
---

<div id="tcomment"></div>
<script is:inline define:vars={{ config, baseUrl: import.meta.env.BASE_URL }}>
  (function(){
    const container = document.getElementById('tcomment');
    if (!container) return;

    const configObj = config || {};
    const base = baseUrl || '/';

    function loadScript(src){
      return new Promise((resolve, reject) => {
        if (document.querySelector('script[src="'+src+'"]')) return resolve();
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = (e) => reject(e);
        document.head.appendChild(s);
      });
    }

    function getCurrentPath() {
      const pathname = window.location.pathname;
      return pathname.endsWith('/') && pathname.length > 1 ? pathname.slice(0, -1) : pathname;
    }

    function createTwikooConfig() {
      return {
        ...configObj,
        path: getCurrentPath(),
        el: '#tcomment'
      };
    }

    function initTwikooIfReady() {
      if (typeof twikoo !== 'undefined') {
        const commentEl = document.getElementById('tcomment');
        if (commentEl) {
          commentEl.innerHTML = '';
          const dynamicConfig = createTwikooConfig();
          console.log('[Twikoo] 初始化配置:', dynamicConfig);
          twikoo.init(dynamicConfig).then(() => {
            console.log('[Twikoo] 初始化完成');
          }).catch((error) => {
            console.error('[Twikoo] 初始化失败:', error);
          });
        }
      } else {
        // 如果 Twikoo 未加载，稍后重试
        setTimeout(initTwikooIfReady, 500);
      }
    }

    function onVisible(){
      observer && observer.disconnect();
      Promise.resolve()
        .then(() => loadScript(base + 'scroll-protection.js'))
        .then(() => loadScript(base + 'assets/js/twikoo.all.min.js'))
        .then(() => initTwikooIfReady())
        .catch((e) => console.error('[Twikoo] 加载失败', e));
    }

    const observer = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) {
          onVisible();
          break;
        }
      }
    }, { root: null, threshold: 0.01 });

    observer.observe(container);

    // If already in viewport, trigger immediately
    if (container.getBoundingClientRect().top <= window.innerHeight) {
      onVisible();
    }

    // Support custom page events (SW up / mizuki)
    document.addEventListener('mizuki:page:loaded', function() {
      if (typeof twikoo !== 'undefined') initTwikooIfReady();
      else onVisible();
    });
  })();
</script>