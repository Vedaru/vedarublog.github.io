---
import ConfigCarrier from "@components/ConfigCarrier.astro";
import MusicPlayer from "@components/widget/MusicPlayer.svelte";
import Pio from "@components/widget/Pio.svelte"; // 使用 Svelte 版本的 Pio 组件
import DiaryYearMonthTOC from "@components/widget/DiaryYearMonthTOC.astro"; // 导入日记目录组件以注册 custom element
import {
	musicPlayerConfig,
	pioConfig,
	profileConfig,
	siteConfig,
} from "@/config";
import { umamiConfig } from "../config";

// 构建时获取音乐数据
interface MetingSong {
	title: string;
	author: string;
	url: string;
	pic: string;
	lrc: string;
}

let audioListJson = "[]";
if (musicPlayerConfig.enable && musicPlayerConfig.mode === "meting") {
	try {
		// 优先尝试通过静态导入使用仓库内的本地播放列表（public/music/playlist.json）。
		// 使用动态 import 可以避免在不同构建环境中依赖 Node 专用 API（如 fs 或 __dirname）。
		try {
			const localPlaylist = await import('../../public/music/playlist.json', { assert: { type: 'json' } });
			audioListJson = JSON.stringify(localPlaylist?.default ?? localPlaylist);
		} catch (e) {
			// 若本地 JSON 不存在或无法导入，则根据环境决定是否回退到 Meting API
			const isDev = (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.MODE === 'development') || process.env.NODE_ENV === 'development';
			if (isDev) {
				console.log('ℹ Dev mode: skipping Meting API fetch; enable local playlist or run the download script to populate public/music');
			} else {
				const PLAYLIST_ID = musicPlayerConfig.id ?? '28364371';
				const SERVER = musicPlayerConfig.server ?? 'netease';
				// 优先使用配置中的 meting_api；回退到候选列表或旧默认模板
				const template = musicPlayerConfig.meting_api ?? (musicPlayerConfig.meting_api_candidates && musicPlayerConfig.meting_api_candidates[0]) ?? `https://api.i-meto.com/meting/api?server=:server&type=:type&id=:id`;
				let apiUrl = template;
				if (template.includes(':server') || template.includes(':type') || template.includes(':id')) {
					apiUrl = template.replace(':server', SERVER).replace(':type', 'playlist').replace(':id', PLAYLIST_ID);
				}
				const response = await fetch(apiUrl);
				const data: MetingSong[] = await response.json();
				const audioList = data.map((song: any) => ({
					name: song.title,
					artist: song.author,
					url: song.url, // 使用API返回的完整URL
					cover: song.pic,
					lrc: song.lrc
				}));
				audioListJson = JSON.stringify(audioList);
			}
		}
	} catch (e) {
		console.warn("Failed to fetch or load music data:", e);
	}
}

const BANNER_HEIGHT = 35;
const BANNER_HEIGHT_EXTEND = 30;
const BANNER_HEIGHT_HOME = BANNER_HEIGHT + BANNER_HEIGHT_EXTEND;

import {
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";

import "../styles/mobile-navbar.css";
import "../styles/wallpaper-navbar-transparent.css";
import "../styles/fancybox-custom.css";
import "../styles/expressive-code.css";
import "../styles/panel-animations.css";
import "../styles/postcard-optimization.css";
import "../styles/layout-stability.css";

declare global {
	interface Window {
		BANNER_HEIGHT?: number;
		BANNER_HEIGHT_EXTEND?: number;
		BANNER_HEIGHT_HOME?: number;
	}
}

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } =
	Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
	siteConfig.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
console.debug('Navbar transparent mode:', navbarTransparentMode);

// 获取默认banner图片的辅助函数
const getDefaultBanner = (): string => {
	const src = siteConfig.banner.src;
	if (typeof src === "string") {
		return src;
	}
	if (Array.isArray(src)) {
		return src[0] || "";
	}
	if (src && typeof src === "object") {
		// 优先使用desktop，如果没有则使用mobile
		const desktopSrc = src.desktop;
		const mobileSrc = src.mobile;
		if (typeof desktopSrc === "string") {
			return desktopSrc;
		}
		if (Array.isArray(desktopSrc) && desktopSrc.length > 0) {
			return desktopSrc[0];
		}
		if (typeof mobileSrc === "string") {
			return mobileSrc;
		}
		if (Array.isArray(mobileSrc) && mobileSrc.length > 0) {
			return mobileSrc[0];
		}
	}
	return "";
};

if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = getDefaultBanner();
}

// TODO don't use post cover as banner for now
banner = getDefaultBanner();

const enableBanner = !!siteConfig.banner.src;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
	ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];

const umamiEnabled = umamiConfig.enabled || false;
const umamiScripts = umamiConfig.scripts || ""; // 获取Umami scripts配置

// 构建字体配置的 CSS 变量
// ASCII 字体优先级最高（用于英文、数字等），CJK 字体作为回退
let bodyFontFamily = "";
if (siteConfig.font) {
	const fonts: string[] = [];

	// 先添加 ASCII 字体（优先级最高）
	if (siteConfig.font.asciiFont?.fontFamily) {
		const asciiFonts = siteConfig.font.asciiFont.fontFamily.split(',').map(f => f.trim());
		asciiFonts.forEach(font => {
			fonts.push(font.includes(" ") && !font.startsWith('"') && !font.startsWith("'") ? `"${font}"` : font);
		});
	}

	// CJK 字体已禁用以节省资源，使用浏览器默认字体
	// if (siteConfig.font.cjkFont?.fontFamily) {
	// 	const cjkFonts = siteConfig.font.cjkFont.fontFamily.split(',').map(f => f.trim());
	// 	cjkFonts.forEach(font => {
	// 		fonts.push(font.includes(" ") && !font.startsWith('"') && !font.startsWith("'") ? `"${font}"` : font);
	// 	});
	// }

	// 添加系统字体作为最终回退
	fonts.push(
		"system-ui",
		"-apple-system",
		"BlinkMacSystemFont",
		"'Segoe UI'",
		"Roboto",
		"Oxygen",
		"Ubuntu",
		"Cantarell",
		"'Open Sans'",
		"'Helvetica Neue'",
		"sans-serif",
	);

	// 组合成完整的 font-family 字符串
	bodyFontFamily = fonts.join(", ");
}
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>
		<!-- 网易云音乐防盗链 -->
		{musicPlayerConfig.enable && <meta name="referrer" content="no-referrer" />}
		
		<!-- 字体预加载优化：移除非关键字体预加载，避免阻塞渲染 -->
		{/* 仅预加载关键 ASCII 字体，如果需要 */}
		{siteConfig.font?.asciiFont?.localFonts?.slice(0, 1).map((f) => (
			<link rel="preload" as="font" href={import.meta.env.BASE_URL + `assets/font/${f.replace('.ttf', '.woff2')}`} type="font/woff2" crossorigin fetchpriority="low" />
		))}
		{/* CJK 字体完全移除预加载，依赖 font-display: swap */}
		<!-- 第三方分析脚本 - 延迟加载优化（移到外部文件） -->
		<script src="/js/analytics-loader.js" is:inline></script>
		<!-- 主题初始化脚本 - 移到外部文件并延迟加载 -->
		<script src="/js/theme-init.js" defer is:inline></script>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description || pageTitle}>
		{siteConfig.keywords && siteConfig.keywords.length > 0 && (
			<meta name="keywords" content={siteConfig.keywords.join(', ')} />
		)}
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || pageTitle}>
		{ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
		{
			setOGTypeArticle ? (
				<meta property="og:type" content="article" />
			) : (
				<meta property="og:type" content="website" />
			)
		}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || pageTitle}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- DNS 预解析和预连接 - 加速第三方资源加载 -->
		<link rel="dns-prefetch" href="https://www.googletagmanager.com">
		<link rel="dns-prefetch" href="https://www.clarity.ms">
		<link rel="dns-prefetch" href="https://www.bilibili.uno">
		<link rel="preconnect" href="https://www.bilibili.uno" crossorigin="anonymous">
		
		<!-- 预加载关键图片以优化 LCP -->
		{isHomePage && (
			<link rel="preload" as="image" href={url("/assets/home/Image_1764853150683.webp")} fetchpriority="high" />
		)}
		{Astro.url.pathname.includes('/anime') && (
			<link rel="preload" as="image" href="/assets/anime/86139c9ac6572ee5c3ab9ac61f77a51f4405240c.webp" fetchpriority="high" />
		)}
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- 主题初始化脚本已移到外部文件 -->
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
		}}></style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->



		<slot name="head"></slot>

		<!-- Pio 看板娘样式和脚本延迟加载（可配置） -->
		{pioConfig.enable && pioConfig.eagerLoad && (
			<>
				<script src={import.meta.env.BASE_URL + "pio/static/l2d.js"} defer is:inline></script>
				<script src={import.meta.env.BASE_URL + "pio/static/pio.js"} defer is:inline></script>
				<link rel="stylesheet" href={import.meta.env.BASE_URL + "pio/static/pio.css"} />
			</>
		)}

		<!-- MusicPlayer 外部 API 连接优化 -->
		{musicPlayerConfig.enable && (
			<>
				<link rel="preconnect" href="https://www.bilibili.uno" crossorigin />
				<link rel="dns-prefetch" href="https://www.bilibili.uno" />
			</>
		)}

		<!-- 预连接本地资源以加速 Pio 加载 -->
		{pioConfig.enable && (
			<link rel="preconnect" href={import.meta.env.BASE_URL} crossorigin />
		)}

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

		<!-- Umami Analytics -->
		{umamiEnabled && umamiScripts && <Fragment set:html={umamiScripts} />}

		<!-- 脚本加载优化器 - 延迟加载非关键脚本 -->
		<script src="/js/script-loader-optimizer.js" defer></script>

</head>
	<body class=" min-h-screen " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  style={bodyFontFamily ? `font-family: ${bodyFontFamily};` : ''}
		  data-overlayscrollbars-initialize
	>
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KRX3XGVH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

		<!-- 全局加载页面（覆盖层） -->
		<style is:inline>
			/* 旋转加载动画，适配明暗主题 */
			.loader-spinner {
				width: 2rem; /* 32px */
				height: 2rem;
				border-radius: 9999px;
				border: 3px solid rgba(0,0,0,0.12);
				border-top-color: rgba(0,0,0,0.6);
				animation: mizuki-spin 0.8s linear infinite;
			}
			.dark .loader-spinner {
				border: 3px solid rgba(255,255,255,0.18);
				border-top-color: rgba(255,255,255,0.85);
			}
			@keyframes mizuki-spin { to { transform: rotate(360deg); } }
		</style>

		<div id="global-loading" class="fixed inset-0 z-[10000] flex items-center justify-center bg-[var(--page-bg)] transition-opacity duration-300">
			<div class="flex flex-col items-center gap-4">
				<div class="loader-spinner"></div>
				<div class="text-sm opacity-70">
					正在加载...
				</div>
			</div>
		</div>

		<script is:inline>
			(function(){
				const el = document.getElementById('global-loading');
				if(!el) return;
				function show(){
					// 标记加载开始，添加根级控制类以隐藏 Pio UI
					try { window.__loadingScreenDone = false; } catch {}
					try { document.documentElement.classList.add('loading-active'); } catch {}
					el.style.display = 'flex';
					el.classList.remove('opacity-0');
					el.setAttribute('aria-hidden','false');
					// 广播自定义事件供组件监听
					try { window.dispatchEvent(new CustomEvent('mizuki:loading:start')); } catch {}
				}
				function hide(){
					el.classList.add('opacity-0');
					el.setAttribute('aria-hidden','true');
					setTimeout(()=>{ el.style.display = 'none'; }, 300);
					// 移除控制类并标记加载完成
					try { document.documentElement.classList.remove('loading-active'); } catch {}
					try { window.__loadingScreenDone = true; } catch {}
					// 广播加载结束事件
					try { window.dispatchEvent(new CustomEvent('mizuki:loading:end')); } catch {}
				}
				// 仅在初次页面加载时显示，Swup 页面切换时不显示
				if (document.readyState === 'complete') {
					// 页面已经加载完成（例如通过快速切换或返回），直接隐藏
					hide();
				} else {
					show();
					window.addEventListener('load', hide, { once: true });
				}

				// Swup 页面切换时不显示加载界面，由页面过渡动画处理
			})();
		</script>
		
		<!-- 设置构建时获取的音乐数据 -->
		{musicPlayerConfig.enable && musicPlayerConfig.mode === "meting" && (
			<script define:vars={{ audioListJson }}>
				window.musicData = JSON.parse(audioListJson);
			</script>
		)}
		
		<ConfigCarrier></ConfigCarrier>
		<slot />
		
		<!-- Lazy-load KaTeX CSS 仅在页面包含数学(KaTeX)元素时加载，减少首屏 CSS 体积 -->
		<script is:inline>
			(function(){
				try{
					if (typeof document !== 'undefined' && document.querySelector('.katex')) {
						const l = document.createElement('link');
						l.rel = 'stylesheet';
						l.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css';
						l.crossOrigin = 'anonymous';
						document.head.appendChild(l);
					}
				} catch(e){}
			})();
		</script>

		<!-- Music Player - 延迟加载以减少首屏 JS（从 client:load -> client:idle） -->
		{musicPlayerConfig.enable && (
			<MusicPlayer client:idle />
		)}
		
		<!-- Pio 看板娘组件 - 改为延迟加载（从 client:load -> client:idle） -->
		{pioConfig.enable && <Pio client:idle baseURL={import.meta.env.BASE_URL} />}
		
		<!-- 日记目录组件 - 隐藏但加载 script 以注册 custom element -->
		<div class="hidden">
			<DiaryYearMonthTOC groupedMoments={[]} />
		</div>
		
		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>

		<!-- 日记目录数据注入脚本 -->
		<script is:inline>
			// 使用 window 对象存储数据，避免重复声明
			window.diaryGroupedMoments = window.diaryGroupedMoments || null;
			
			// 等待自定义元素注册
			async function waitForCustomElement(tagName, timeout = 5000) {
				const startTime = Date.now();
				while (Date.now() - startTime < timeout) {
					if (customElements.get(tagName)) {
						console.log('[Layout] Custom element registered:', tagName);
						return true;
					}
					await new Promise(resolve => setTimeout(resolve, 50));
				}
				console.warn('[Layout] Custom element not registered within timeout:', tagName);
				return false;
			}

			// 从页面读取日记数据
			function loadDiaryDataFromPage() {
				console.log('[Layout] Looking for diary-page-data...');
				const dataElement = document.getElementById('diary-page-data');
				console.log('[Layout] diary-page-data element:', dataElement);
				if (!dataElement) {
					console.log('[Layout] No diary-page-data element found');
					// 尝试查找所有带 data-page-type 的元素
					const allDataElements = document.querySelectorAll('[data-page-type="diary"]');
					console.log('[Layout] Found elements with data-page-type="diary":', allDataElements.length);
					if (allDataElements.length > 0) {
						console.log('[Layout] First element:', allDataElements[0]);
					}
					return null;
				}
				
				const dataAttr = dataElement.getAttribute('data-grouped-moments');
				console.log('[Layout] data-grouped-moments length:', dataAttr ? dataAttr.length : 0);
				if (!dataAttr) {
					console.warn('[Layout] data-grouped-moments attribute is empty');
					return null;
				}
				
				try {
					const data = JSON.parse(dataAttr);
					console.log('[Layout] Loaded diary data from page, years:', data.length);
					return data;
				} catch (e) {
					console.error('[Layout] Failed to parse diary data:', e);
					return null;
				}
			}

			// 注入日记目录数据
			// 使用全局变量避免重复声明错误
			if (typeof window.isInjecting === 'undefined') {
				window.isInjecting = false;
			}
			async function injectDiaryTOC() {
				console.log('[Layout] injectDiaryTOC called');
				
				// 防止重复注入
				if (window.isInjecting) {
					console.log('[Layout] Already injecting, skipping...');
					return;
				}
				window.isInjecting = true;
				
				const diaryTocWrapper = document.getElementById('diary-toc-wrapper');
				const diaryTocContainer = document.getElementById('diary-toc');
				
				if (!diaryTocContainer || !diaryTocWrapper) {
					console.warn('[Layout] TOC containers not found');
					window.isInjecting = false;
					return;
				}
				
				// 等待自定义元素注册
				await waitForCustomElement('diary-table-of-contents');
				
				// 从页面加载数据
				const groupedMoments = loadDiaryDataFromPage();
				if (!groupedMoments || !Array.isArray(groupedMoments) || groupedMoments.length === 0) {
					console.log('[Layout] No diary data available');
					window.isInjecting = false;
					return;
				}
				
				window.diaryGroupedMoments = groupedMoments;
				const groupedMomentsJSON = JSON.stringify(groupedMoments);
				console.log('[Layout] Found diary data, years:', groupedMoments.length, 'JSON length:', groupedMomentsJSON.length);
				
				// 创建或更新 diary-table-of-contents 元素
				let diaryToc = diaryTocContainer.querySelector('diary-table-of-contents');
				
				if (!diaryToc) {
					diaryToc = document.createElement('diary-table-of-contents');
					diaryToc.className = 'group';
					diaryTocContainer.appendChild(diaryToc);
					console.log('[Layout] Created new diary-table-of-contents element');
				}
				
				// 设置数据属性(此时wrapper还是hidden状态,元素在后台渲染)
				diaryToc.setAttribute('data-grouped-moments', groupedMomentsJSON);
				console.log('[Layout] Diary TOC data injected successfully');
				
				// 等待两帧确保自定义元素完全初始化和渲染完成
				requestAnimationFrame(() => {
					requestAnimationFrame(() => {
						// 先显示但保持透明
						diaryTocWrapper.classList.remove('hidden');
						diaryTocWrapper.classList.add('lg:block');
						
						// 再等一帧后开始淡入,确保display:block已生效
						requestAnimationFrame(() => {
							diaryTocWrapper.classList.remove('opacity-0');
							diaryTocWrapper.classList.add('opacity-100');
							console.log('[Layout] Diary TOC fade in complete');
							window.isInjecting = false;
						});
					});
				});
			}
			
			// 隐藏日记目录（非日记页面）
			function hideDiaryTOC() {
				// 清除数据
				window.diaryGroupedMoments = null;
				
				const diaryTocWrapper = document.getElementById('diary-toc-wrapper');
				if (diaryTocWrapper) {
					// 先淡出
					diaryTocWrapper.classList.remove('opacity-100');
					diaryTocWrapper.classList.add('opacity-0');
					// 等待过渡完成后隐藏
					setTimeout(() => {
						diaryTocWrapper.classList.add('hidden');
						diaryTocWrapper.classList.remove('lg:block');
					}, 300); // 与 transition duration 匹配
					console.log('[Layout] Diary TOC hidden');
				}
			}
			
			// 初始加载
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', () => {
					if (window.location.pathname.includes('/diary')) {
						injectDiaryTOC();
					}
				});
			} else {
				if (window.location.pathname.includes('/diary')) {
					injectDiaryTOC();
				}
			}
			
			// Swup 页面切换 - 使用 page:view 事件确保 DOM 完全加载
			document.addEventListener('swup:page:view', () => {
				console.log('[Layout] swup:page:view fired, pathname:', window.location.pathname);
				if (window.location.pathname.includes('/diary')) {
					injectDiaryTOC();
				} else {
					hideDiaryTOC();
				}
			});
		</script>
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
	
	/* Water waves animation */
	.waves > .parallax use {
		animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
	}

	@keyframes wave {
		0% {
			transform: translate3d(-90px, 0, 0);
		}
		100% {
			transform: translate3d(85px, 0, 0);
		}
	}

	/* 顶端导航栏渐变高光动画（与主题色联动） */
	.top-gradient-highlight {
		position: fixed;
		left: 0;
		right: 0;
		top: 0;
		height: 4px;
		z-index: 9998;
		pointer-events: none;
		/* 使用主题色 hue 构建渐变 */
		background: linear-gradient(90deg,
			hsl(var(--hue, 60) 90% 62%),
			hsl(var(--hue, 60) 90% 70%),
			hsl(var(--hue, 60) 90% 62%)
		);
		background-size: 200% 100%;
		opacity: 0.75;
		filter: drop-shadow(0 0 6px hsl(var(--hue, 60) 90% 60% / 0.4));
		animation: navbarGradientMove 6s linear infinite;
	}

	@keyframes navbarGradientMove {
		0% { background-position: 0% 50%; }
		100% { background-position: 200% 50%; }
	}
}
</style>

<script>
// import { animationManager } from '../utils/animation-utils';
import 'overlayscrollbars/overlayscrollbars.css';
// import {
// 	OverlayScrollbars,
// 	// ScrollbarsHidingPlugin,
// 	// SizeObserverPlugin,
// 	// ClickScrollPlugin
// } from 'overlayscrollbars';
// import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	// BANNER_HEIGHT,
	// BANNER_HEIGHT_HOME,
	// BANNER_HEIGHT_EXTEND,
	// MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
	DARK_MODE,
	DEFAULT_THEME
} from "../constants/constants";


// 保证全局脚本作用域可用BANNER_HEIGHT等变量
const BANNER_HEIGHT = window.BANNER_HEIGHT || 35;
const BANNER_HEIGHT_EXTEND = window.BANNER_HEIGHT_EXTEND || 30;
const BANNER_HEIGHT_HOME = window.BANNER_HEIGHT_HOME || 65;
// const MAIN_PANEL_OVERLAPS_BANNER_HEIGHT = 3.5;
import { siteConfig } from '../config';
import { widgetConfigs } from "../config";
import { initSakura } from "../utils/sakura-manager";
// 尝试静态导入面板管理器，确保构建时被打包并能在运行时直接使用
import { panelManager as panelManagerStatic } from '../utils/panel-manager';

// const setTimeout = window.setTimeout;
// @ts-ignore
const setTimeout = (callback: any, delay: any) => window.setTimeout(callback, delay);

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

// 导入面板管理器
async function initializePanelManager() {
	try {
		// 使用静态导入的实例，避免运行时尝试去请求未映射的路径
		const panelManager = panelManagerStatic;

		// 防止重复绑定
		if ((window as any).__panelManagerInitialized) {
			return panelManager;
		}
		(window as any).__panelManagerInitialized = true;
		
		// 配置面板和它们的忽略元素
		const panelConfigs: Array<{ panel: string; ignores: string[] }> = [
			{ panel: "display-setting", ignores: ["display-setting", "display-settings-switch"] },
			{ panel: "nav-menu-panel", ignores: ["nav-menu-panel", "nav-menu-switch"] },
			{ panel: "search-panel", ignores: ["search-panel", "search-bar", "search-switch"] },
			{ panel: "mobile-toc-panel", ignores: ["mobile-toc-panel", "mobile-toc-switch"] },
			{ panel: "wallpaper-mode-panel", ignores: ["wallpaper-mode-panel", "wallpaper-mode-switch"] }
		];
		
		// 单个全局点击监听器
		document.addEventListener("click", async event => {
			let tDom = event.target;
			if (!(tDom instanceof Node)) return;
			
			// 遍历所有面板配置
			for (const config of panelConfigs) {
				let shouldIgnore = false;
				
				// 检查是否应该忽略这个点击
				for (const ignoreId of config.ignores) {
					const ignoreElement = document.getElementById(ignoreId);
					if (ignoreElement && (ignoreElement === tDom || ignoreElement.contains(tDom))) {
						shouldIgnore = true;
						break;
					}
				}
				
				// 如果不应该忽略，则关闭该面板
				if (!shouldIgnore) {
					const panel = document.getElementById(config.panel);
					if (panel && !panel.classList.contains("float-panel-closed")) {
						console.log('Closing panel via outside click:', config.panel);
						if (panelManager) {
							await panelManager.closePanel(config.panel as any);
						}
					}
				}
			}
		});
		
		return panelManager;
	} catch (error) {
		console.error('Failed to initialize panel manager:', error);
		return null;
	}
}
const pmInstance = initializePanelManager();
if (pmInstance) {
	(window as any).panelManager = pmInstance;
}


// function _loadTheme() {
// 	const theme = getStoredTheme()
// 	setTheme(theme)
// }

// function _loadHue() {
// 	setHue(getHue())
// }

function initCustomScrollbar() {
	// 完全禁用OverlayScrollbars的body初始化，避免导致页面重新加载
	// 只处理katex元素的滚动条
	const katexElements = document.querySelectorAll('.katex-display:not([data-scrollbar-initialized])') as NodeListOf<HTMLElement>;
	katexElements.forEach(element => {
		if (!element.parentNode) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		// 使用简单的CSS滚动条而不是OverlayScrollbars
		container.style.cssText = `
			overflow-x: auto;
			scrollbar-width: thin;
			scrollbar-color: rgba(0,0,0,0.3) transparent;
		`;
		
		// 为webkit浏览器添加自定义滚动条样式
		const style = document.createElement('style');
		style.textContent = `
			.katex-display-container::-webkit-scrollbar {
				height: 6px;
			}
			.katex-display-container::-webkit-scrollbar-track {
				background: transparent;
			}
			.katex-display-container::-webkit-scrollbar-thumb {
				background: rgba(0,0,0,0.3);
				border-radius: 3px;
			}
			.katex-display-container::-webkit-scrollbar-thumb:hover {
				background: rgba(0,0,0,0.5);
			}
		`;
		if (!document.head.querySelector('style[data-katex-scrollbar]')) {
			style.setAttribute('data-katex-scrollbar', 'true');
			document.head.appendChild(style);
		}

		element.setAttribute('data-scrollbar-initialized', 'true');
	});
}

function showBanner() {
	// 使用requestAnimationFrame优化DOM操作
	requestAnimationFrame(() => {
		// Handle single image banner (desktop)
		const banner = document.getElementById('banner');
		if (banner) {
			banner.classList.remove('opacity-0', 'scale-105');
		}

		// Handle mobile single image banner - 使用与电脑端相同的逻辑
		const mobileBanner = document.querySelector('.block.lg\\:hidden[alt="Mobile banner image of the blog"]');
		if (mobileBanner && !document.getElementById('banner-carousel')) {
			// 移动端使用与电脑端相同的初始化逻辑
			mobileBanner.classList.remove('opacity-0', 'scale-105');
			mobileBanner.classList.add('opacity-100');
		}

		// Handle carousel banner - 立即初始化，移除延迟
		const carousel = document.getElementById('banner-carousel');
		if (carousel) {
			// 立即初始化轮播，移除延迟以改善流畅性
			initCarousel();
		}
	});
}

function initCarousel() {
	const carouselItems = document.querySelectorAll('.carousel-item');
	
	// 根据屏幕尺寸过滤有效的轮播项
	const isMobile = window.innerWidth < 1024; // lg breakpoint
	const validItems = Array.from(carouselItems).filter(item => {
		if (isMobile) {
			// 移动端：只显示有mobile图片的项目
			return item.querySelector('.block.lg\\:hidden');
		} else {
			// 桌面端：只显示有desktop图片的项目
			return item.querySelector('.hidden.lg\\:block');
		}
	});
	
	// Check if carousel is disabled but we have multiple images - show random image
	if (validItems.length > 1 && !siteConfig.banner.carousel?.enable) {
		// Hide all images first
		carouselItems.forEach((item, _index) => {
			item.classList.add('opacity-0', 'scale-110');
			item.classList.remove('opacity-100', 'scale-100');
		});
		
		// Show random valid image
		const randomIndex = Math.floor(Math.random() * validItems.length);
		const randomItem = validItems[randomIndex];
		
		randomItem.classList.add('opacity-100', 'scale-100');
		randomItem.classList.remove('opacity-0', 'scale-110');
		return;
	}
	
	if (validItems.length > 1 && siteConfig.banner.carousel?.enable) {
		let currentIndex = 0;
		const interval = siteConfig.banner.carousel?.interval || 6;
		let carouselInterval: any;
		let isPaused = false;

		// 移动端触摸手势支持
		let startX = 0;
		let startY = 0;
		let isSwiping = false;
		const carousel = document.getElementById('banner-carousel');

		// 切换图片的函数 - 基于有效项目
		function switchToSlide(index: number) {
			// 隐藏当前图片
			const currentItem = validItems[currentIndex];
			currentItem.classList.remove('opacity-100', 'scale-100');
			currentItem.classList.add('opacity-0', 'scale-110');

			// 更新索引
			currentIndex = index;
			
			// 显示新图片
			const nextItem = validItems[currentIndex];
			nextItem.classList.add('opacity-100', 'scale-100');
			nextItem.classList.remove('opacity-0', 'scale-110');
		}

		// 初始化：隐藏所有图片，只显示第一张有效图片
		carouselItems.forEach((item) => {
			item.classList.add('opacity-0', 'scale-110');
			item.classList.remove('opacity-100', 'scale-100');
		});
		
		// 显示第一张有效图片
		if (validItems.length > 0) {
			validItems[0].classList.add('opacity-100', 'scale-100');
			validItems[0].classList.remove('opacity-0', 'scale-110');
		}

		// 移动端触摸事件
		if (carousel && 'ontouchstart' in window) {
			carousel.addEventListener('touchstart', (e) => {
				startX = e.touches[0].clientX;
				startY = e.touches[0].clientY;
				isSwiping = false;
				isPaused = true;
				clearInterval(carouselInterval);
			}, { passive: true });

			carousel.addEventListener('touchmove', (e) => {
				if (!startX || !startY) return;
				
				const diffX = Math.abs(e.touches[0].clientX - startX);
				const diffY = Math.abs(e.touches[0].clientY - startY);
				
				// 判断是否为水平滑动
				if (diffX > diffY && diffX > 30) {
					isSwiping = true;
					e.preventDefault();
				}
			}, { passive: false });

			carousel.addEventListener('touchend', (e) => {
				if (!startX || !startY || !isSwiping) {
					isPaused = false;
					startCarousel();
					return;
				}
				
				const endX = e.changedTouches[0].clientX;
				const diffX = startX - endX;
				
				// 滑动距离超过50px才切换
				if (Math.abs(diffX) > 50) {
					if (diffX > 0) {
					// 向左滑动，显示下一张
					const nextIndex = (currentIndex + 1) % validItems.length;
					switchToSlide(nextIndex);
				} else {
					// 向右滑动，显示上一张
					const prevIndex = (currentIndex - 1 + validItems.length) % validItems.length;
					switchToSlide(prevIndex);
				}
				}
				
				startX = 0;
				startY = 0;
				isSwiping = false;
				isPaused = false;
				
				// 重新开始自动轮播
				startCarousel();
			}, { passive: true });
		}

		// 开始轮播的函数
		function startCarousel() {
			clearInterval(carouselInterval);
			carouselInterval = setInterval(() => {
				if (!isPaused) {
					const nextIndex = (currentIndex + 1) % validItems.length;
					switchToSlide(nextIndex);
				}
			}, interval * 1000);
		}

		// 鼠标悬停暂停（桌面端）
		if (carousel) {
			carousel.addEventListener('mouseenter', () => {
				isPaused = true;
				clearInterval(carouselInterval);
			});

			carousel.addEventListener('mouseleave', () => {
				isPaused = false;
				startCarousel();
			});
		}

		// 开始自动轮播
		startCarousel();
	}
}

function setupSakura() {
	const sakuraConfig = (widgetConfigs as any)?.sakura;
	if (!sakuraConfig || !sakuraConfig.enable) return;
	if ((window as any).sakuraInitialized) return;
	initSakura(sakuraConfig);
	(window as any).sakuraInitialized = true;
}

if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', setupSakura);
} else {
	setupSakura();
}

const setup = () => {
	if (!window.swup || !window.swup.hooks) return;
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// 简化navbar处理逻辑
		if (bannerEnabled) {
			const navbar = document.getElementById('navbar-wrapper')
			if (navbar && document.body.classList.contains('lg:is-home')) {
				const threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 88
				if (document.documentElement.scrollTop >= threshold) {
					navbar.classList.add('navbar-hidden')
				}
			}
		}
	})
	window.swup.hooks.on('content:replace', () => {
		// 只处理新的katex元素的滚动条，使用原生CSS滚动条
		initCustomScrollbar();
		
		// 检查当前页面是否为文章页面（有TOC元素）
		const tocWrapper = document.getElementById('toc-wrapper');
		const isArticlePage = tocWrapper !== null;
		
		// 只在文章页面重新初始化 TOC 组件
		if (isArticlePage) {
			const tocElement = document.querySelector('table-of-contents');
			if (tocElement && typeof (tocElement as any).init === 'function') {
				setTimeout(() => {
					(tocElement as any).init();
				}, 100);
			}
			
			// 重新初始化移动端 TOC 组件
			if (typeof (window as any).mobileTOCInit === 'function') {
				setTimeout(() => {
					(window as any).mobileTOCInit();
				}, 100);
			}
		}
		
		// 检查当前页面是否为日记页面
		const isDiaryPage = window.location.pathname.includes('/diary');
		const diaryTocWrapper = document.getElementById('diary-toc-wrapper');
		
		if (diaryTocWrapper) {
			if (isDiaryPage) {
				// 显示日记目录
				diaryTocWrapper.classList.remove('hidden');
				diaryTocWrapper.classList.add('lg:block');
				
				// 重新初始化日记目录组件
				const diaryTocElement = document.querySelector('diary-table-of-contents');
				if (diaryTocElement && typeof (diaryTocElement as any).init === 'function') {
					setTimeout(() => {
						(diaryTocElement as any).init();
					}, 100);
				}
			} else {
				// 隐藏日记目录
				diaryTocWrapper.classList.add('hidden');
				diaryTocWrapper.classList.remove('lg:block');
			}
		}
		
		
		// 重新初始化semifull模式的滚动检测
		const navbar = document.getElementById('navbar')
		if (navbar) {
			const transparentMode = navbar.getAttribute('data-transparent-mode')
			
			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof (window as any).initSemifullScrollDetection === 'function') {
					(window as any).initSemifullScrollDetection()
				}
			}
		}
	})
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		const isHomePage = pathsEqual(visit.to.url, url('/'))
		
		if (isHomePage) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// Control banner text visibility based on page
		const bannerTextOverlay = document.querySelector('.banner-text-overlay')
		if (bannerTextOverlay) {
			if (isHomePage) {
				bannerTextOverlay.classList.remove('hidden')
			} else {
				bannerTextOverlay.classList.add('hidden')
			}
		}

		// Control navbar transparency based on page
		const navbar = document.getElementById('navbar')
		if (navbar) {
			navbar.setAttribute('data-is-home', isHomePage.toString())
			
			// 重新初始化semifull模式的滚动检测
			const transparentMode = navbar.getAttribute('data-transparent-mode')
			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof window.initSemifullScrollDetection === 'function') {
					window.initSemifullScrollDetection()
				}
			}
		}

		// Control mobile banner visibility based on page with improved staging animation
		const bannerWrapper = document.getElementById('banner-wrapper')
		const mainContentWrapper = document.querySelector('.absolute.w-full.z-30')
		
		if (bannerWrapper && mainContentWrapper) {
			if (isHomePage) {
				// 首页：延迟移除隐藏类，让banner和内容优雅地出现
				setTimeout(() => {
					bannerWrapper.classList.remove('mobile-hide-banner')
				}, 100)
				setTimeout(() => {
					mainContentWrapper.classList.remove('mobile-main-no-banner')
				}, 150)
			} else {
				// 非首页：分阶段隐藏，先隐藏banner，再移动内容
				bannerWrapper.classList.add('mobile-hide-banner')
				// 延迟移动内容，让banner先完全消失
				setTimeout(() => {
					mainContentWrapper.classList.add('mobile-main-no-banner')
				}, 100)
			}
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}
		
		// 确保页面滚动到顶部，特别是移动端banner关闭时
		window.scrollTo({
			top: 0,
			behavior: 'instant'
		});
		
		// 同步主题状态 - 解决从首页进入文章页面时代码块渲染问题
		const storedTheme = localStorage.getItem('theme') || DEFAULT_THEME;
		const isDark = storedTheme === DARK_MODE;
		const expectedTheme = isDark ? 'github-dark' : 'github-light';
		const currentTheme = document.documentElement.getAttribute('data-theme');
		const hasDarkClass = document.documentElement.classList.contains('dark');
		
		// 如果主题不匹配，使用批量更新减少重绘
		if (currentTheme !== expectedTheme || hasDarkClass !== isDark) {
			// 使用 requestAnimationFrame 批量更新，减少重绘
			requestAnimationFrame(() => {
				// 同步 data-theme 属性
				if (currentTheme !== expectedTheme) {
					document.documentElement.setAttribute('data-theme', expectedTheme);
				}
				// 同步 dark class
				if (hasDarkClass !== isDark) {
					if (isDark) {
						document.documentElement.classList.add('dark');
					} else {
						document.documentElement.classList.remove('dark');
					}
				}
			});
		}
		
		// 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
		setTimeout(() => {
			if (document.getElementById('tcomment')) {
				// 触发自定义事件，通知评论系统页面已完全加载
				const pageLoadedEvent = new CustomEvent('mizuki:page:loaded', {
					detail: {
						path: window.location.pathname,
						timestamp: Date.now()
					}
				});
				document.dispatchEvent(pageLoadedEvent);
				console.log('Layout: 触发 mizuki:page:loaded 事件，路径:', window.location.pathname);
			}
		}, 300);
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')

// 节流函数
function throttle(func: Function, limit: number) {
	let inThrottle: boolean;
	return function(this: any) {
		const args = arguments;
		const context = this;
		if (!inThrottle) {
			func.apply(context, args);
			inThrottle = true;
			setTimeout(() => inThrottle = false, limit);
		}
	}
}

function scrollFunction() {
	const scrollTop = document.documentElement.scrollTop;
	const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

	// 批量处理DOM操作
	requestAnimationFrame(() => {
		if (backToTopBtn) {
			if (scrollTop > bannerHeight) {
				backToTopBtn.classList.remove('hide')
			} else {
				backToTopBtn.classList.add('hide')
			}
		}

		if (bannerEnabled && toc) {
			if (scrollTop > bannerHeight) {
				toc.classList.remove('toc-hide')
			} else {
				toc.classList.add('toc-hide')
			}
		}

		if (bannerEnabled && navbar) {
			const isHome = document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024;
			const currentBannerHeight = isHome ? BANNER_HEIGHT_HOME : BANNER_HEIGHT;
			const threshold = window.innerHeight * (currentBannerHeight / 100) - 88;
			
			if (scrollTop >= threshold) {
				navbar.classList.add('navbar-hidden')
			} else {
				navbar.classList.remove('navbar-hidden')
			}
		}
	});
}

// 使用节流优化滚动性能
window.onscroll = throttle(scrollFunction, 16); // 约60fps

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

// 页面加载完成后初始化banner和轮播图
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', async () => {
		showBanner();
		// 初始化面板管理器（使用静态导入实例）
		try {
			if (panelManagerStatic) console.log('Panel manager initialized');
		} catch (error) {
			console.error('Failed to initialize panel manager:', error);
		}
		// 初始化右侧栏布局管理器
		try {
			const layoutModule = await import('../scripts/right-sidebar-layout.js');
			if (layoutModule) console.log('Right sidebar layout initialized');
		} catch (error) {
			console.error('Failed to initialize right sidebar layout:', error);
		}
	});
} else {
	showBanner();
	// 页面已经加载完成，立即初始化面板管理器
	(async () => {
		try {
			if (panelManagerStatic) console.log('Panel manager initialized');
		} catch (error) {
			console.error('Failed to initialize panel manager:', error);
		}
		// 初始化右侧栏布局管理器
		try {
			const layoutModule = await import(/* webpackChunkName: "right-sidebar" */ '../scripts/right-sidebar-layout.js');
			if (layoutModule) console.log('Right sidebar layout initialized');
		} catch (error) {
			console.error('Failed to initialize right sidebar layout:', error);
		}
	})();
}

</script>

<!-- 代码块折叠功能 -->
<script>
import '../scripts/code-collapse.js';
</script>

<!-- 主题切换综合性能优化器（包含代码块优化、重型元素优化、性能诊断） -->
<script>
import '../scripts/theme-optimizer.js';
</script>

<script>
import { Fancybox } from "@fancyapps/ui";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

// 存储 Fancybox 绑定的选择器
let fancyboxSelectors: string[] = [];

function initFancybox() {
  // 不需要关闭所有实例，只需检查是否已经初始化
  if (fancyboxSelectors.length > 0) {
    return; // 已经初始化，直接返回
  }
  
  // 通用配置
  const commonConfig = {
    Thumbs: {
      autoStart: true,
      showOnStart: "yes",
    },
    Toolbar: {
      display: {
        left: ["infobar"],
        middle: [
          "zoomIn",
          "zoomOut",
          "toggle1to1",
          "rotateCCW",
          "rotateCW",
          "flipX",
          "flipY",
        ],
        right: ["slideshow", "thumbs", "close"],
      },
    },
    animated: true,
    dragToClose: true,
    keyboard: {
      Escape: "close",
      Delete: "close",
      Backspace: "close",
      PageUp: "next",
      PageDown: "prev",
      ArrowUp: "next",
      ArrowDown: "prev",
      ArrowRight: "next",
      ArrowLeft: "prev",
    },
    fitToView: true,
    preload: 3,
    infinite: true,
    Panzoom: {
      maxScale: 3,
      minScale: 1,
    },
    caption: false
  };
  
  // 存储 Fancybox 绑定的选择器
  // let fancyboxSelectors: string[] = [];

  // 为相册图片添加 Fancybox 支持
  const albumImagesSelector = ".custom-md img, #post-cover img, .moment-images img";
  (Fancybox as any).bind(albumImagesSelector, {
    ...commonConfig,
    groupAll: true,
    Carousel: {
      transition: "slide",
      preload: 2,
    },
  } as any);
  fancyboxSelectors.push(albumImagesSelector);

  // 为相册中的链接添加 Fancybox 支持
  const albumLinksSelector = ".moment-images a[data-fancybox]";
  (Fancybox as any).bind(albumLinksSelector, {
    ...commonConfig,
    source: (el: any) => {
      return el.getAttribute("data-src") || el.getAttribute("href");
    },
  } as any);
  fancyboxSelectors.push(albumLinksSelector);

  // 为单独的 fancybox 图片添加支持
  const singleFancyboxSelector = "[data-fancybox]:not(.moment-images a)";
  (Fancybox as any).bind(singleFancyboxSelector, commonConfig as any);
  fancyboxSelectors.push(singleFancyboxSelector);
}

// 清理 Fancybox 实例
function cleanupFancybox() {
  fancyboxSelectors.forEach(selector => {
    (Fancybox as any).unbind(selector);
  });
  fancyboxSelectors = [];
}

const setup = () => {
  // 初始化 Fancybox
  initFancybox();
  
  // 在页面视图更改时重新初始化
  window.swup.hooks.on("page:view", () => {
    // 清理旧实例
    cleanupFancybox();
    // 等待 DOM 更新后初始化
    requestAnimationFrame(() => {
      initFancybox();
    });
  });
}

// 图片加载完成标记脚本
function markImagesAsLoaded() {
  const images = document.querySelectorAll('.card-base img[loading="lazy"]');
  images.forEach(img => {
    const imgElement = img as HTMLImageElement;
    if (imgElement.complete && imgElement.naturalHeight > 0) {
      imgElement.classList.add('loaded');
    } else {
      imgElement.addEventListener('load', () => {
        imgElement.classList.add('loaded');
      }, { once: true });
    }
  });
}

// 初始化图片加载标记
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', markImagesAsLoaded);
} else {
  markImagesAsLoaded();
}

if (window?.swup?.hooks) {
  setup()
} else {
  document.addEventListener("swup:enable", setup)
  
  // 如果 swup 尚未初始化，则直接初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initFancybox);
  } else {
    initFancybox();
  }
}
</script>
