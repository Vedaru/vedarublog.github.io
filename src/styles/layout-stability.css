/**
 * 布局稳定性优化 - 减少 CLS (Cumulative Layout Shift)
 * 通过 CSS transform 替代动态 top 定位，使用 will-change 提升渲染性能
 */

/* 1. 使用 CSS 变量和 margin-top 以减少布局偏移 */
.main-content-stable {
    /* 预留空间，防止布局偏移 */
    min-height: 100vh;
    /* 使用 CSS 变量控制顶部距离，避免 JS 直接修改 style */
    margin-top: var(--main-top, 5.5rem);
    /* 使用 transform 替代 margin 的动画过渡 */
    transition: margin-top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 2. 为可能导致 CLS 的元素预留尺寸 */
.navbar-placeholder {
    min-height: 5.5rem;
    contain: layout style;
}

/* 3. 骨架屏样式 - 为异步加载内容提供占位 */
.skeleton-loading {
    background: linear-gradient(
        90deg,
        rgba(var(--card-bg-rgb), 0.3) 0%,
        rgba(var(--card-bg-rgb), 0.5) 50%,
        rgba(var(--card-bg-rgb), 0.3) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
    border-radius: 0.5rem;
}

@keyframes skeleton-shimmer {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* 4. 固定尺寸容器 - 防止内容加载时跳动 */
.fixed-height-container {
    min-height: 600px;
    contain: layout;
}

/* 5. 字体加载优化 - 已在实际 @font-face 规则中设置 font-display: swap */
/* @font-face {
    font-display: swap;
} */

/* 6. 图片容器固定比例 - 防止图片加载导致布局偏移 */
.aspect-ratio-box {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 */
    contain: layout;
}

.aspect-ratio-box > img,
.aspect-ratio-box > div {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 7. 优化 z-index 分层 - 确保元素不会因层级变化导致重排 */
.z-layer-base {
    isolation: isolate;
}

/* 8. 内容可见性优化 - 延迟渲染屏幕外内容 */
.content-visibility-auto {
    content-visibility: auto;
    contain-intrinsic-size: 0 500px;
}

/* 9. 防止异步组件导致 CLS */
astro-island {
    display: block;
    min-height: 1px; /* 确保有最小高度 */
    contain: layout style paint;
}

/* 10. 优化侧边栏加载 - 防止 #sidebar CLS */
.sidebar-stable,
#sidebar {
    min-height: 300px;
    /* 预留固定宽度，避免内容加载时横向偏移 */
    min-width: 250px;
}

/* 10.1 右侧边栏稳定性 */
.right-sidebar-container {
    min-height: 300px;
    /* 使用 visibility 而不是 display 来隐藏，保持布局空间 */
    transition: opacity 0.2s ease, visibility 0.2s ease;
}

.right-sidebar-container.hidden-in-grid-mode {
    opacity: 0;
    visibility: hidden;
    /* 不使用 display: none，避免布局偏移 */
}

/* 11. 减少隐藏元素影响 */
.hidden-no-layout {
    display: none !important;
    /* 确保 hidden 元素完全不占用布局空间 */
}

/* 12. Banner 区域稳定性 - 防止壁纸切换引起 CLS */
.banner-stable,
.wallpaper-transparent,
[data-fullscreen-wallpaper] {
    height: var(--banner-height, 45vh);
    /* 使用 transform 进行显示/隐藏切换，而不是 display */
    transition: opacity 0.3s ease, transform 0.3s ease;
}

/* 壁纸模式切换优化 */
body.enable-banner .main-content-stable {
    --main-top: var(--banner-height, 35vh);
}

body.no-banner-mode .main-content-stable,
body.wallpaper-transparent .main-content-stable {
    --main-top: 5.5rem;
}

/* 壁纸透明效果优化 - 避免透明度变化引起重绘 */
.wallpaper-transparent {
    backface-visibility: hidden;
}

/* 13. 主网格布局优化 - 防止网格切换引起 CLS */
#main-grid {
    /* 使用 grid 的 auto-flow 确保平滑布局 */
    grid-auto-flow: dense;
    /* 预留最小高度，防止内容加载时跳动 */
    min-height: 500px;
    /* 使用 CSS Grid 的 minmax 确保列宽稳定 */
    transition: grid-template-columns 0.3s ease;
}

/* 防止列宽变化引起的 CLS */
#main-grid > * {
    min-height: 100px;
}

/* 14. 减少动画引起的 CLS */
.onload-animation {
    /* 使用 opacity 而非 transform 避免布局计算 */
    animation: fade-in 0.3s ease-out forwards;
}

@keyframes fade-in {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* 15. TOC 固定尺寸 */
.toc-container {
    min-width: 250px;
    min-height: 200px;
    contain: layout style;
}

/* 16. 响应式断点优化 - 确保不同设备尺寸下布局稳定 */
@media (max-width: 768px) {
    .fixed-height-container {
        min-height: 400px;
    }
}

/* 17. 预加载关键资源 - 减少布局变化 */
.preload-visible {
    /* 立即可见的内容不使用 content-visibility */
    content-visibility: visible;
}

/* 18. 滚动容器优化 */
.scroll-container-stable {
    /* 使用 contain 避免影响外部布局 */
    contain: layout style paint;
    /* 启用硬件加速 */
    will-change: scroll-position;
    /* 优化滚动性能 */
    -webkit-overflow-scrolling: touch;
}

/* 19. Footer 固定最小高度 */
.footer-stable {
    min-height: 150px;
    contain: layout;
}

/* 20. 动态内容容器 */
.dynamic-content {
    /* 为动态加载的内容预留空间 */
    min-height: var(--min-content-height, 300px);
    contain: layout style;
}

/* 21. 防止 pointer-events 切换导致的重排 */
.pointer-events-none {
    pointer-events: none;
    /* 使用 GPU 加速 */
    transform: translateZ(0);
    will-change: auto;
}

/* 22. 固定定位元素优化 - 减少对文档流的影响 */
.absolute,
.fixed {
    /* 使用 GPU 加速 */
    backface-visibility: hidden;
}

/* 24. 减少手机端 banner 隐藏导致的 CLS */
@media (max-width: 768px) {
    .mobile-hide-banner .main-content-stable {
        --main-top: 5.5rem !important;
    }
    
    .mobile-main-no-banner {
        margin-top: 5.5rem !important;
    }
}

/* 25. 图片对象覆盖优化 - 防止图片加载引起 CLS */
.w-full.h-full.object-cover {
    /* 预先分配空间 */
    aspect-ratio: 16 / 9;
}

/* 26. 避免类切换引起的重排 */
.transition-all,
.transition {
    /* 限制过渡属性，避免触发 layout */
    transition-property: opacity, transform, filter, box-shadow;
    will-change: opacity, transform;
}

/* 27. Z-index 层级稳定性 */
.z-30,
.z-40,
.z-50 {
    /* 使用独立的层叠上下文 */
    isolation: isolate;
}

/* 28. 防止模式切换时的突然变化 */
body.enable-banner,
body.wallpaper-transparent,
body.no-banner-mode {
    /* 模式切换时平滑过渡 */
    transition: background-color 0.3s ease;
}

/* 32. 响应式网格优化 */
@media (min-width: 1024px) {
    #main-grid {
        /* 桌面端固定网格模板 */
        grid-template-columns: minmax(250px, 17.5rem) minmax(0, 1fr) minmax(250px, 17.5rem);
    }
}

/* 33. 预加载状态优化 */
[data-wallpaper-mode] {
    /* 根据壁纸模式预设样式 */
    will-change: margin-top, transform;
}

[data-wallpaper-mode="banner"] {
    --expected-main-top: 35vh;
}

[data-wallpaper-mode="fullscreen"],
[data-wallpaper-mode="none"] {
    --expected-main-top: 5.5rem;
}
